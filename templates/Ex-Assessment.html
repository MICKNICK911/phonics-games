<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results Manager</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aacd6;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d11467;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e0861b;
        }

        .btn-info {
            background-color: #7209b7;
            color: white;
        }

        .btn-info:hover {
            background-color: #5a08a0;
        }

        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: text;
        }

        .table-title:focus {
            background-color: white;
            color: var(--dark);
            outline: none;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f1f5fd;
            font-weight: 600;
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f9fafc;
        }

        .editable {
            outline: none;
            border: 1px solid transparent;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 100%;
        }

        .editable:focus {
            border-color: var(--primary-light);
            background-color: #f0f4ff;
        }

        .numeric {
            text-align: right;
        }

        .position-cell {
            font-weight: 600;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .saved-indicator {
            color: var(--success);
        }

        .input-hint {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 3px;
            font-style: italic;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-table, .print-table * {
                visibility: visible;
            }
            
            .print-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 14px;
            }
            
            .print-table table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .print-table th, 
            .print-table td {
                padding: 8px 10px;
                border: 1px solid #ddd;
            }
            
            .print-table th {
                background-color: #f1f5fd;
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Student Results Manager</h1>
            <div>
                <div class="controls">
                    <button id="addTableBtn" class="btn-primary">üìã Add New Table</button>
                    <button id="importBtn" class="btn-success">üìÅ Import Data</button>
                    <button id="exportBtn" class="btn-warning">üíæ Export Data</button>
                    <button id="clearDataBtn" class="btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
                <div class="status-indicator" id="statusIndicator">
                    <span id="saveStatus">All changes saved</span>
                </div>
            </div>
        </header>

        <main id="tablesContainer">
            <!-- Tables will be dynamically added here -->
            <div class="empty-state" id="emptyState">
                <p>No tables created yet. Click "Add New Table" to get started.</p>
                <button id="initialAddTable" class="btn-primary">üìã Create First Table</button>
            </div>
        </main>

        <footer class="footer">
            <p>Student Results Manager &copy; 2023 | All changes are automatically saved to your device</p>
            <p class="input-hint">Tip: You can enter marks in any format (e.g., 45/50) and they will be converted automatically</p>
        </footer>
    </div>

    <input type="file" id="fileInput" class="file-input" accept=".json">

    <script>
        // Global state
        let tables = [];
        let tableCounter = 1;
        let saveTimeout = null;
        const STORAGE_KEY = 'studentResultsData';

        // DOM elements
        const tablesContainer = document.getElementById('tablesContainer');
        const emptyState = document.getElementById('emptyState');
        const addTableBtn = document.getElementById('addTableBtn');
        const initialAddTableBtn = document.getElementById('initialAddTable');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const fileInput = document.getElementById('fileInput');
        const saveStatus = document.getElementById('saveStatus');

        // Sample data for initial table
        const initialStudents = [
            "Augustine", "Nhyiraba", "Daniella", "Melvina", "Godsway", 
            "Agyeiwaa", "Boatemaa", "Nana Kofi", "Ginko", "Ariana"
        ];

        // Maximum marks for each category
        const maxMarks = {
            cat1: 15,
            cat2: 20,
            cat3: 15,
            exam: 50
        };

        // Event listeners
        addTableBtn.addEventListener('click', addNewTable);
        initialAddTableBtn.addEventListener('click', addNewTable);
        importBtn.addEventListener('click', () => fileInput.click());
        exportBtn.addEventListener('click', exportData);
        clearDataBtn.addEventListener('click', clearAllData);
        fileInput.addEventListener('change', handleFileImport);

        // Initialize app
        function init() {
            loadFromLocalStorage();
            if (tables.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
                renderTables();
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    tables = parsedData.tables || [];
                    tableCounter = parsedData.tableCounter || 1;
                    console.log('Data loaded from localStorage');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                // If there's an error, start with empty state
                tables = [];
                tableCounter = 1;
            }
        }

        // Save data to localStorage with debouncing
        function saveToLocalStorage() {
            // Clear any pending save
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Update status
            saveStatus.textContent = 'Saving...';
            saveStatus.className = '';
            
            // Debounce the save to prevent too frequent writes
            saveTimeout = setTimeout(() => {
                try {
                    const dataToSave = {
                        tables: tables,
                        tableCounter: tableCounter,
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // Update status
                    saveStatus.textContent = 'All changes saved';
                    saveStatus.className = 'saved-indicator';
                    
                    console.log('Data saved to localStorage');
                } catch (error) {
                    console.error('Error saving data to localStorage:', error);
                    saveStatus.textContent = 'Error saving data';
                    saveStatus.className = '';
                }
            }, 500);
        }

        // Parse mark input and convert to appropriate scale
        function parseMarkInput(input, maxMark) {
            if (input === '' || input === null || input === undefined) {
                return 0;
            }
            
            // Convert to string and trim
            const strInput = String(input).trim();
            
            // Handle fraction format (e.g., "45/50")
            if (strInput.includes('/')) {
                const parts = strInput.split('/');
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    
                    // Check for valid numbers and avoid division by zero
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        // Calculate the percentage and apply to maxMark
                        const percentage = numerator / denominator;
                        const convertedMark = percentage * maxMark;
                        
                        // Round to nearest integer
                        return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                    }
                }
            }
            
            // Handle percentage format (e.g., "90%")
            if (strInput.includes('%')) {
                const percentage = parseFloat(strInput);
                if (!isNaN(percentage)) {
                    const convertedMark = (percentage / 100) * maxMark;
                    return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                }
            }
            
            // Handle decimal numbers
            const numValue = parseFloat(strInput);
            if (!isNaN(numValue)) {
                // If the number is greater than maxMark, assume it's already in the correct scale
                if (numValue > maxMark) {
                    return maxMark;
                }
                // Otherwise, return the number rounded to nearest integer
                return Math.min(Math.max(Math.round(numValue), 0), maxMark);
            }
            
            // If we can't parse the input, return 0
            return 0;
        }

        // Create a new table
        function addNewTable() {
            const tableId = `table-${tableCounter++}`;
            const tableData = {
                id: tableId,
                name: `Class ${tableCounter - 1}`,
                students: initialStudents.map(name => ({
                    name,
                    cat1: 0,
                    cat2: 0,
                    cat3: 0,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0
                }))
            };
            
            tables.push(tableData);
            renderTables();
            hideEmptyState();
            saveToLocalStorage();
        }

        // Render all tables
        function renderTables() {
            tablesContainer.innerHTML = '';
            
            tables.forEach(tableData => {
                const tableElement = createTableElement(tableData);
                tablesContainer.appendChild(tableElement);
            });
            
            // Update positions for all tables
            tables.forEach(table => updatePositions(table.id));
        }

        // Create table HTML element
        function createTableElement(tableData) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            tableContainer.id = tableData.id;
            
            // Table header with title and actions
            const tableHeader = document.createElement('div');
            tableHeader.className = 'table-header';
            
            const tableTitle = document.createElement('div');
            tableTitle.className = 'table-title';
            tableTitle.setAttribute('contenteditable', 'true');
            tableTitle.textContent = tableData.name;
            tableTitle.addEventListener('blur', (e) => {
                updateTableName(tableData.id, e.target.textContent);
            });
            tableTitle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    tableTitle.blur();
                }
            });
            
            const tableActions = document.createElement('div');
            tableActions.className = 'table-actions';
            
            const printBtn = document.createElement('button');
            printBtn.className = 'btn-info';
            printBtn.innerHTML = 'üñ®Ô∏è Print';
            printBtn.addEventListener('click', () => printTable(tableData.id));
            
            const renameBtn = document.createElement('button');
            renameBtn.className = 'btn-success';
            renameBtn.innerHTML = '‚úèÔ∏è Edit Name';
            renameBtn.addEventListener('click', () => {
                tableTitle.focus();
                // Select all text for easier editing
                const range = document.createRange();
                range.selectNodeContents(tableTitle);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-danger';
            deleteBtn.innerHTML = 'üóëÔ∏è Delete';
            deleteBtn.addEventListener('click', () => deleteTable(tableData.id));
            
            tableActions.appendChild(printBtn);
            tableActions.appendChild(renameBtn);
            tableActions.appendChild(deleteBtn);
            
            tableHeader.appendChild(tableTitle);
            tableHeader.appendChild(tableActions);
            
            // Create the table
            const table = document.createElement('table');
            
            // Table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headers = [
                'NAMES', 'CAT1 Marks 15', 'CAT2 Marks 20', 'CAT3 Marks 15', 
                'CAT Totals 50', 'EXAM Marks 50', 'TOTAL CAT+ EXAM Marks 100', 'POSITION'
            ];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            // Add actions header
            const actionsHeader = document.createElement('th');
            actionsHeader.textContent = 'ACTIONS';
            headerRow.appendChild(actionsHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Table body
            const tbody = document.createElement('tbody');
            
            tableData.students.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                const nameInput = document.createElement('span');
                nameInput.className = 'editable';
                nameInput.textContent = student.name;
                nameInput.setAttribute('contenteditable', 'true');
                nameInput.addEventListener('blur', (e) => {
                    updateStudentName(tableData.id, index, e.target.textContent);
                });
                nameCell.appendChild(nameInput);
                row.appendChild(nameCell);
                
                // CAT1 cell
                const cat1Cell = document.createElement('td');
                cat1Cell.className = 'numeric';
                const cat1Input = document.createElement('span');
                cat1Input.className = 'editable';
                cat1Input.textContent = student.cat1;
                cat1Input.setAttribute('contenteditable', 'true');
                cat1Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat1);
                    updateStudentMark(tableData.id, index, 'cat1', convertedMark);
                });
                cat1Cell.appendChild(cat1Input);
                row.appendChild(cat1Cell);
                
                // CAT2 cell
                const cat2Cell = document.createElement('td');
                cat2Cell.className = 'numeric';
                const cat2Input = document.createElement('span');
                cat2Input.className = 'editable';
                cat2Input.textContent = student.cat2;
                cat2Input.setAttribute('contenteditable', 'true');
                cat2Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat2);
                    updateStudentMark(tableData.id, index, 'cat2', convertedMark);
                });
                cat2Cell.appendChild(cat2Input);
                row.appendChild(cat2Cell);
                
                // CAT3 cell
                const cat3Cell = document.createElement('td');
                cat3Cell.className = 'numeric';
                const cat3Input = document.createElement('span');
                cat3Input.className = 'editable';
                cat3Input.textContent = student.cat3;
                cat3Input.setAttribute('contenteditable', 'true');
                cat3Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat3);
                    updateStudentMark(tableData.id, index, 'cat3', convertedMark);
                });
                cat3Cell.appendChild(cat3Input);
                row.appendChild(cat3Cell);
                
                // CAT Total cell (calculated)
                const catTotalCell = document.createElement('td');
                catTotalCell.className = 'numeric';
                catTotalCell.textContent = student.catTotal;
                row.appendChild(catTotalCell);
                
                // EXAM cell
                const examCell = document.createElement('td');
                examCell.className = 'numeric';
                const examInput = document.createElement('span');
                examInput.className = 'editable';
                examInput.textContent = student.exam;
                examInput.setAttribute('contenteditable', 'true');
                examInput.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.exam);
                    updateStudentMark(tableData.id, index, 'exam', convertedMark);
                });
                examCell.appendChild(examInput);
                row.appendChild(examCell);
                
                // TOTAL cell (calculated)
                const totalCell = document.createElement('td');
                totalCell.className = 'numeric';
                totalCell.textContent = student.total;
                row.appendChild(totalCell);
                
                // POSITION cell (calculated)
                const positionCell = document.createElement('td');
                positionCell.className = 'position-cell';
                positionCell.textContent = student.position;
                row.appendChild(positionCell);
                
                // Add row actions
                const actionsCell = document.createElement('td');
                const deleteStudentBtn = document.createElement('button');
                deleteStudentBtn.className = 'btn-danger';
                deleteStudentBtn.innerHTML = 'üóëÔ∏è';
                deleteStudentBtn.title = 'Delete Student';
                deleteStudentBtn.addEventListener('click', () => deleteStudent(tableData.id, index));
                
                actionsCell.appendChild(deleteStudentBtn);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            
            // Add student button
            const addStudentRow = document.createElement('div');
            addStudentRow.style.padding = '15px 20px';
            addStudentRow.style.borderTop = '1px solid var(--border)';
            
            const addStudentBtn = document.createElement('button');
            addStudentBtn.className = 'btn-primary';
            addStudentBtn.innerHTML = '‚ûï Add Student';
            addStudentBtn.addEventListener('click', () => addStudent(tableData.id));
            
            addStudentRow.appendChild(addStudentBtn);
            
            tableContainer.appendChild(tableHeader);
            tableContainer.appendChild(table);
            tableContainer.appendChild(addStudentRow);
            
            return tableContainer;
        }

        // Update table name
        function updateTableName(tableId, newName) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                table.name = newName || `Class ${tableCounter}`;
                saveToLocalStorage();
            }
        }

        // Update student name
        function updateStudentName(tableId, studentIndex, newName) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                table.students[studentIndex].name = newName || 'Unnamed Student';
                renderTables();
                saveToLocalStorage();
            }
        }

        // Update student mark
        function updateStudentMark(tableId, studentIndex, markType, value) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                table.students[studentIndex][markType] = value;
                
                // Recalculate totals
                recalculateTotals(tableId, studentIndex);
                updatePositions(tableId);
                renderTables();
                saveToLocalStorage();
            }
        }

        // Recalculate totals for a student
        function recalculateTotals(tableId, studentIndex) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                const student = table.students[studentIndex];
                student.catTotal = student.cat1 + student.cat2 + student.cat3;
                student.total = student.catTotal + student.exam;
            }
        }

        // Update positions based on total marks
        function updatePositions(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                // Sort students by total marks in descending order
                const sortedStudents = [...table.students].sort((a, b) => b.total - a.total);
                
                // Assign positions
                let currentPosition = 1;
                let previousTotal = null;
                
                sortedStudents.forEach((student, index) => {
                    // If this student has the same total as the previous, they share the position
                    if (previousTotal !== null && student.total === previousTotal) {
                        // Same position as previous student
                        student.position = currentPosition;
                    } else {
                        currentPosition = index + 1;
                        student.position = currentPosition;
                    }
                    
                    previousTotal = student.total;
                });
            }
        }

        // Add a new student to a table
        function addStudent(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                table.students.push({
                    name: 'New Student',
                    cat1: 0,
                    cat2: 0,
                    cat3: 0,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0
                });
                
                updatePositions(tableId);
                renderTables();
                saveToLocalStorage();
            }
        }

        // Delete a student from a table
        function deleteStudent(tableId, studentIndex) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                if (confirm('Are you sure you want to delete this student?')) {
                    table.students.splice(studentIndex, 1);
                    updatePositions(tableId);
                    renderTables();
                    saveToLocalStorage();
                }
            }
        }

        // Delete a table
        function deleteTable(tableId) {
            if (confirm('Are you sure you want to delete this table? This action cannot be undone.')) {
                tables = tables.filter(t => t.id !== tableId);
                
                if (tables.length === 0) {
                    showEmptyState();
                } else {
                    renderTables();
                }
                saveToLocalStorage();
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone and will delete all tables.')) {
                tables = [];
                tableCounter = 1;
                localStorage.removeItem(STORAGE_KEY);
                showEmptyState();
                saveStatus.textContent = 'All data cleared';
                saveStatus.className = '';
            }
        }

        // Print a specific table
        function printTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (!table) return;
            
            // Create a print-friendly version of the table
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${table.name} - Student Results</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                        }
                        .print-header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 14px;
                        }
                        .print-table th, .print-table td {
                            border: 1px solid #ddd;
                            padding: 8px 10px;
                            text-align: left;
                        }
                        .print-table th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        .print-table .numeric {
                            text-align: right;
                        }
                        .print-table .position-cell {
                            text-align: center;
                            font-weight: bold;
                        }
                        @page {
                            size: A4 portrait;
                            margin: 0.5cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>${table.name}</h1>
                        <p>Student Results Summary</p>
                    </div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>NAMES</th>
                                <th>CAT1 Marks 15</th>
                                <th>CAT2 Marks 20</th>
                                <th>CAT3 Marks 15</th>
                                <th>CAT Totals 50</th>
                                <th>EXAM Marks 50</th>
                                <th>TOTAL CAT+ EXAM Marks 100</th>
                                <th>POSITION S</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${table.students.map(student => `
                                <tr>
                                    <td>${student.name}</td>
                                    <td class="numeric">${student.cat1}</td>
                                    <td class="numeric">${student.cat2}</td>
                                    <td class="numeric">${student.cat3}</td>
                                    <td class="numeric">${student.catTotal}</td>
                                    <td class="numeric">${student.exam}</td>
                                    <td class="numeric">${student.total}</td>
                                    <td class="position-cell">${student.position}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; font-size: 12px; text-align: center;">
                        Generated on ${new Date().toLocaleDateString()}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
                // Optional: close the window after printing
                // printWindow.close();
            };
        }

        // Hide empty state
        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // Show empty state
        function showEmptyState() {
            emptyState.style.display = 'block';
        }

        // Export data as JSON
        function exportData() {
            if (tables.length === 0) {
                alert('No data to export. Please add tables first.');
                return;
            }
            
            const dataStr = JSON.stringify({
                tables: tables,
                tableCounter: tableCounter,
                exportedAt: new Date().toISOString()
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'student-results-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Handle file import
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate imported data structure
                    if (Array.isArray(importedData.tables) && importedData.tables.every(item => 
                        item.id && item.name && Array.isArray(item.students))) {
                        
                        tables = importedData.tables;
                        tableCounter = importedData.tableCounter || tables.length + 1;
                        renderTables();
                        hideEmptyState();
                        saveToLocalStorage();
                        alert('Data imported successfully!');
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>