<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results Manager</title>
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aacd6;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d11467;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e0861b;
        }

        .btn-info {
            background-color: #7209b7;
            color: white;
        }

        .btn-info:hover {
            background-color: #5a08a0;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-help {
            background-color: #f8961e;
            color: white;
        }

        .btn-help:hover {
            background-color: #e0861b;
        }

        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: text;
        }

        .table-title:focus {
            background-color: white;
            color: var(--dark);
            outline: none;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f1f5fd;
            font-weight: 600;
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f9fafc;
        }

        .editable {
            outline: none;
            border: 1px solid transparent;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 100%;
        }

        .editable:focus {
            border-color: var(--primary-light);
            background-color: #f0f4ff;
        }

        .numeric {
            text-align: right;
        }

        .position-cell {
            font-weight: 600;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .saved-indicator {
            color: var(--success);
        }

        .input-hint {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 3px;
            font-style: italic;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background-color: var(--primary);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        /* Clickable student names in statistics */
        .clickable-name {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s;
        }

        .clickable-name:hover {
            color: var(--secondary);
        }

        /* Terminal report styles */
        .terminal-report {
            width: 100%;
        }

        .terminal-report table {
            width: 100%;
            margin-bottom: 20px;
        }

        .terminal-report th {
            background-color: #f1f5fd;
        }

        .terminal-report .remarks-cell {
            font-weight: 600;
            text-align: center;
        }

        .remarks-excellent {
            color: #28a745;
        }

        .remarks-very-good {
            color: #20c997;
        }

        .remarks-good {
            color: #17a2b8;
        }

        .remarks-pass {
            color: #ffc107;
        }

        .remarks-fail {
            color: #dc3545;
        }

        .comments-section {
            margin-top: 20px;
        }

        .comments-section h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .comments-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .terminal-report-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Help content styles */
        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
        }

        .help-section ul {
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 8px;
        }

        .help-section code {
            background-color: #f1f5fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--primary);
        }

        .feature-card h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        /* Import summary styles */
        .import-summary {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
        }

        .import-summary h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .import-summary ul {
            padding-left: 20px;
        }

        .import-summary li {
            margin-bottom: 5px;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-table, .print-table * {
                visibility: visible;
            }
            
            .print-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 14px;
            }
            
            .print-table table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .print-table th, 
            .print-table td {
                padding: 8px 10px;
                border: 1px solid #ddd;
            }
            
            .print-table th {
                background-color: #f1f5fd;
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Student Results Manager</h1>
            <div>
                <div class="controls">
                    <button id="addTableBtn" class="btn-primary">üìã Add New Table</button>
                    <button id="importBtn" class="btn-success">üìÅ Import Data</button>
                    <button id="exportBtn" class="btn-warning">üíæ Export Data</button>
                    <button id="statisticsBtn" class="btn-info">üìà Statistics</button>
                    <button id="helpBtn" class="btn-help">‚ùì Help</button>
                    <button id="clearDataBtn" class="btn-danger">üóëÔ∏è Clear All Data</button>
                </div>
                <div class="status-indicator" id="statusIndicator">
                    <span id="saveStatus">All changes saved</span>
                </div>
            </div>
        </header>

        <main id="tablesContainer">
            <!-- Tables will be dynamically added here -->
            <div class="empty-state" id="emptyState">
                <p>No tables created yet. Click "Add New Table" to get started.</p>
                <button id="initialAddTable" class="btn-primary">üìã Create First Table</button>
            </div>
        </main>

        <footer class="footer">
            <p>Student Results Manager &copy; 2025 | Designed by Sir Mick | +233545800158</p>
            <p class="input-hint">Tip: You can enter marks in any format (e.g., 45/50, 90%, 14) and they will be converted automatically</p>
        </footer>
    </div>

    <input type="file" id="fileInput" class="file-input" accept=".json">

    <!-- Statistics Modal -->
    <div id="statisticsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Overall Statistics</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statisticsContainer">
                    <!-- Statistics table will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal Report Modal -->
    <div id="terminalReportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìù Student Terminal Report</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="terminalReportContainer">
                    <!-- Terminal report will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ùì Student Results Manager - Help Guide</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="helpContainer">
                    <!-- Help content will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let tables = [];
        let tableCounter = 1;
        let saveTimeout = null;
        const STORAGE_KEY = 'studentResultsData';

        // Maximum marks for each category
        const maxMarks = {
            cat1: 15,
            cat2: 20,
            cat3: 15,
            exam: 50
        };

        // DOM elements
        const tablesContainer = document.getElementById('tablesContainer');
        const emptyState = document.getElementById('emptyState');
        const addTableBtn = document.getElementById('addTableBtn');
        const initialAddTableBtn = document.getElementById('initialAddTable');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const statisticsBtn = document.getElementById('statisticsBtn');
        const helpBtn = document.getElementById('helpBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const fileInput = document.getElementById('fileInput');
        const saveStatus = document.getElementById('saveStatus');
        const statisticsModal = document.getElementById('statisticsModal');
        const terminalReportModal = document.getElementById('terminalReportModal');
        const helpModal = document.getElementById('helpModal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const statisticsContainer = document.getElementById('statisticsContainer');
        const terminalReportContainer = document.getElementById('terminalReportContainer');
        const helpContainer = document.getElementById('helpContainer');

        // Sample data for initial table
        const initialStudents = [
            "name 1", "name 2", "name 3", "name 4", "name 5", 
            "name 6", "name 7", "name 8", "name 9", "name 10"
        ];

        // Event listeners
        addTableBtn.addEventListener('click', addNewTable);
        initialAddTableBtn.addEventListener('click', addNewTable);
        importBtn.addEventListener('click', () => fileInput.click());
        exportBtn.addEventListener('click', exportData);
        statisticsBtn.addEventListener('click', showStatistics);
        helpBtn.addEventListener('click', showHelp);
        clearDataBtn.addEventListener('click', clearAllData);
        fileInput.addEventListener('change', handleFileImport);
        
        // Close modal events
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-overlay');
                if (modal) modal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        });

        // Initialize app
        function init() {
            loadFromLocalStorage();
            if (tables.length === 0) {
                showEmptyState();
            } else {
                hideEmptyState();
                renderTables();
            }
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    tables = parsedData.tables || [];
                    tableCounter = parsedData.tableCounter || 1;
                    console.log('Data loaded from localStorage');
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                // If there's an error, start with empty state
                tables = [];
                tableCounter = 1;
            }
        }

        // Save data to localStorage with debouncing
        function saveToLocalStorage() {
            // Clear any pending save
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            // Update status
            saveStatus.textContent = 'Saving...';
            saveStatus.className = '';
            
            // Debounce the save to prevent too frequent writes
            saveTimeout = setTimeout(() => {
                try {
                    const dataToSave = {
                        tables: tables,
                        tableCounter: tableCounter,
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    // Update status
                    saveStatus.textContent = 'All changes saved';
                    saveStatus.className = 'saved-indicator';
                    
                    console.log('Data saved to localStorage');
                } catch (error) {
                    console.error('Error saving data to localStorage:', error);
                    saveStatus.textContent = 'Error saving data';
                    saveStatus.className = '';
                }
            }, 500);
        }

        // Parse mark input and convert to appropriate scale
        function parseMarkInput(input, maxMark) {
            if (input === '' || input === null || input === undefined) {
                return 0;
            }
            
            // Convert to string and trim
            const strInput = String(input).trim();
            
            // Handle fraction format (e.g., "45/50")
            if (strInput.includes('/')) {
                const parts = strInput.split('/');
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    
                    // Check for valid numbers and avoid division by zero
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        // Calculate the percentage and apply to maxMark
                        const percentage = numerator / denominator;
                        const convertedMark = percentage * maxMark;
                        
                        // Round to nearest integer
                        return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                    }
                }
            }
            
            // Handle percentage format (e.g., "90%")
            if (strInput.includes('%')) {
                const percentage = parseFloat(strInput);
                if (!isNaN(percentage)) {
                    const convertedMark = (percentage / 100) * maxMark;
                    return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                }
            }
            
            // Handle decimal numbers
            const numValue = parseFloat(strInput);
            if (!isNaN(numValue)) {
                // If the number is greater than maxMark, assume it's already in the correct scale
                if (numValue > maxMark) {
                    return maxMark;
                }
                // Otherwise, return the number rounded to nearest integer
                return Math.min(Math.max(Math.round(numValue), 0), maxMark);
            }
            
            // If we can't parse the input, return 0
            return 0;
        }

        // Create a new table
        function addNewTable() {
            const tableId = `table-${tableCounter++}`;
            const tableData = {
                id: tableId,
                name: `Class ${tableCounter - 1}`,
                students: initialStudents.map(name => ({
                    name,
                    cat1: 0,
                    cat2: 0,
                    cat3: 0,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0
                }))
            };
            
            tables.push(tableData);
            renderTables();
            hideEmptyState();
            saveToLocalStorage();
        }

        // Create a new table with names from an existing table
        function createTableFromNames(sourceTableId) {
            const sourceTable = tables.find(t => t.id === sourceTableId);
            if (!sourceTable) return;
            
            const tableId = `table-${tableCounter++}`;
            const tableData = {
                id: tableId,
                name: `${sourceTable.name} (Copy)`,
                students: sourceTable.students.map(student => ({
                    name: student.name,
                    cat1: 0,
                    cat2: 0,
                    cat3: 0,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0
                }))
            };
            
            tables.push(tableData);
            renderTables();
            hideEmptyState();
            saveToLocalStorage();
        }

        // Render all tables
        function renderTables() {
            tablesContainer.innerHTML = '';
            
            tables.forEach(tableData => {
                const tableElement = createTableElement(tableData);
                tablesContainer.appendChild(tableElement);
            });
            
            // Update positions for all tables
            tables.forEach(table => updatePositions(table.id));
        }

        // Create table HTML element
        function createTableElement(tableData) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            tableContainer.id = tableData.id;
            
            // Table header with title and actions
            const tableHeader = document.createElement('div');
            tableHeader.className = 'table-header';
            
            const tableTitle = document.createElement('div');
            tableTitle.className = 'table-title';
            tableTitle.setAttribute('contenteditable', 'true');
            tableTitle.textContent = tableData.name;
            tableTitle.addEventListener('blur', (e) => {
                updateTableName(tableData.id, e.target.textContent);
            });
            tableTitle.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    tableTitle.blur();
                }
            });
            
            const tableActions = document.createElement('div');
            tableActions.className = 'table-actions';
            
            const printBtn = document.createElement('button');
            printBtn.className = 'btn-info';
            printBtn.innerHTML = 'üñ®Ô∏è Print';
            printBtn.addEventListener('click', () => printTable(tableData.id));
            
            const cloneBtn = document.createElement('button');
            cloneBtn.className = 'btn-secondary';
            cloneBtn.innerHTML = 'üìù Clone Names';
            cloneBtn.title = 'Create new table with these names';
            cloneBtn.addEventListener('click', () => createTableFromNames(tableData.id));
            
            const renameBtn = document.createElement('button');
            renameBtn.className = 'btn-success';
            renameBtn.innerHTML = '‚úèÔ∏è Edit Name';
            renameBtn.addEventListener('click', () => {
                tableTitle.focus();
                // Select all text for easier editing
                const range = document.createRange();
                range.selectNodeContents(tableTitle);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);
            });
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-danger';
            deleteBtn.innerHTML = 'üóëÔ∏è Delete';
            deleteBtn.addEventListener('click', () => deleteTable(tableData.id));
            
            tableActions.appendChild(printBtn);
            tableActions.appendChild(cloneBtn);
            tableActions.appendChild(renameBtn);
            tableActions.appendChild(deleteBtn);
            
            tableHeader.appendChild(tableTitle);
            tableHeader.appendChild(tableActions);
            
            // Create the table
            const table = document.createElement('table');
            
            // Table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headers = [
                'NAMES', 'CAT1 Marks 15', 'CAT2 Marks 20', 'CAT3 Marks 15', 
                'CAT Totals 50', 'EXAM Marks 50', 'TOTAL CAT+ EXAM Marks 100', 'POSITION S'
            ];
            
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            // Add actions header
            const actionsHeader = document.createElement('th');
            actionsHeader.textContent = 'ACTIONS';
            headerRow.appendChild(actionsHeader);
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Table body
            const tbody = document.createElement('tbody');
            
            tableData.students.forEach((student, index) => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                const nameInput = document.createElement('span');
                nameInput.className = 'editable';
                nameInput.textContent = student.name;
                nameInput.setAttribute('contenteditable', 'true');
                nameInput.addEventListener('blur', (e) => {
                    updateStudentName(tableData.id, index, e.target.textContent);
                });
                nameCell.appendChild(nameInput);
                row.appendChild(nameCell);
                
                // CAT1 cell
                const cat1Cell = document.createElement('td');
                cat1Cell.className = 'numeric';
                const cat1Input = document.createElement('span');
                cat1Input.className = 'editable';
                cat1Input.textContent = student.cat1;
                cat1Input.setAttribute('contenteditable', 'true');
                cat1Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat1);
                    updateStudentMark(tableData.id, index, 'cat1', convertedMark);
                });
                cat1Cell.appendChild(cat1Input);
                row.appendChild(cat1Cell);
                
                // CAT2 cell
                const cat2Cell = document.createElement('td');
                cat2Cell.className = 'numeric';
                const cat2Input = document.createElement('span');
                cat2Input.className = 'editable';
                cat2Input.textContent = student.cat2;
                cat2Input.setAttribute('contenteditable', 'true');
                cat2Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat2);
                    updateStudentMark(tableData.id, index, 'cat2', convertedMark);
                });
                cat2Cell.appendChild(cat2Input);
                row.appendChild(cat2Cell);
                
                // CAT3 cell
                const cat3Cell = document.createElement('td');
                cat3Cell.className = 'numeric';
                const cat3Input = document.createElement('span');
                cat3Input.className = 'editable';
                cat3Input.textContent = student.cat3;
                cat3Input.setAttribute('contenteditable', 'true');
                cat3Input.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.cat3);
                    updateStudentMark(tableData.id, index, 'cat3', convertedMark);
                });
                cat3Cell.appendChild(cat3Input);
                row.appendChild(cat3Cell);
                
                // CAT Total cell (calculated)
                const catTotalCell = document.createElement('td');
                catTotalCell.className = 'numeric';
                catTotalCell.textContent = student.catTotal;
                row.appendChild(catTotalCell);
                
                // EXAM cell
                const examCell = document.createElement('td');
                examCell.className = 'numeric';
                const examInput = document.createElement('span');
                examInput.className = 'editable';
                examInput.textContent = student.exam;
                examInput.setAttribute('contenteditable', 'true');
                examInput.addEventListener('blur', (e) => {
                    const convertedMark = parseMarkInput(e.target.textContent, maxMarks.exam);
                    updateStudentMark(tableData.id, index, 'exam', convertedMark);
                });
                examCell.appendChild(examInput);
                row.appendChild(examCell);
                
                // TOTAL cell (calculated)
                const totalCell = document.createElement('td');
                totalCell.className = 'numeric';
                totalCell.textContent = student.total;
                row.appendChild(totalCell);
                
                // POSITION cell (calculated)
                const positionCell = document.createElement('td');
                positionCell.className = 'position-cell';
                positionCell.textContent = student.position;
                row.appendChild(positionCell);
                
                // Add row actions
                const actionsCell = document.createElement('td');
                const deleteStudentBtn = document.createElement('button');
                deleteStudentBtn.className = 'btn-danger';
                deleteStudentBtn.innerHTML = 'üóëÔ∏è';
                deleteStudentBtn.title = 'Delete Student';
                deleteStudentBtn.addEventListener('click', () => deleteStudent(tableData.id, index));
                
                actionsCell.appendChild(deleteStudentBtn);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            
            // Add student button
            const addStudentRow = document.createElement('div');
            addStudentRow.style.padding = '15px 20px';
            addStudentRow.style.borderTop = '1px solid var(--border)';
            
            const addStudentBtn = document.createElement('button');
            addStudentBtn.className = 'btn-primary';
            addStudentBtn.innerHTML = '‚ûï Add Student';
            addStudentBtn.addEventListener('click', () => addStudent(tableData.id));
            
            addStudentRow.appendChild(addStudentBtn);
            
            tableContainer.appendChild(tableHeader);
            tableContainer.appendChild(table);
            tableContainer.appendChild(addStudentRow);
            
            return tableContainer;
        }

        // Update table name
        function updateTableName(tableId, newName) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                table.name = newName || `Class ${tableCounter}`;
                saveToLocalStorage();
            }
        }

        // Update student name
        function updateStudentName(tableId, studentIndex, newName) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                table.students[studentIndex].name = newName || 'Unnamed Student';
                renderTables();
                saveToLocalStorage();
            }
        }

        // Update student mark
        function updateStudentMark(tableId, studentIndex, markType, value) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                table.students[studentIndex][markType] = value;
                
                // Recalculate totals
                recalculateTotals(tableId, studentIndex);
                updatePositions(tableId);
                renderTables();
                saveToLocalStorage();
            }
        }

        // Recalculate totals for a student
        function recalculateTotals(tableId, studentIndex) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                const student = table.students[studentIndex];
                student.catTotal = student.cat1 + student.cat2 + student.cat3;
                student.total = student.catTotal + student.exam;
            }
        }

        // Update positions based on total marks
        function updatePositions(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                // Sort students by total marks in descending order
                const sortedStudents = [...table.students].sort((a, b) => b.total - a.total);
                
                // Assign positions
                let currentPosition = 1;
                let previousTotal = null;
                
                sortedStudents.forEach((student, index) => {
                    // If this student has the same total as the previous, they share the position
                    if (previousTotal !== null && student.total === previousTotal) {
                        // Same position as previous student
                        student.position = currentPosition;
                    } else {
                        currentPosition = index + 1;
                        student.position = currentPosition;
                    }
                    
                    previousTotal = student.total;
                });
            }
        }

        // Add a new student to a table
        function addStudent(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (table) {
                table.students.push({
                    name: 'New Student',
                    cat1: 0,
                    cat2: 0,
                    cat3: 0,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0
                });
                
                updatePositions(tableId);
                renderTables();
                saveToLocalStorage();
            }
        }

        // Delete a student from a table
        function deleteStudent(tableId, studentIndex) {
            const table = tables.find(t => t.id === tableId);
            if (table && table.students[studentIndex]) {
                if (confirm('Are you sure you want to delete this student?')) {
                    table.students.splice(studentIndex, 1);
                    updatePositions(tableId);
                    renderTables();
                    saveToLocalStorage();
                }
            }
        }

        // Delete a table
        function deleteTable(tableId) {
            if (confirm('Are you sure you want to delete this table? This action cannot be undone.')) {
                tables = tables.filter(t => t.id !== tableId);
                
                if (tables.length === 0) {
                    showEmptyState();
                } else {
                    renderTables();
                }
                saveToLocalStorage();
            }
        }

        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone and will delete all tables.')) {
                tables = [];
                tableCounter = 1;
                localStorage.removeItem(STORAGE_KEY);
                showEmptyState();
                saveStatus.textContent = 'All data cleared';
                saveStatus.className = '';
            }
        }

        // Show statistics modal
        function showStatistics() {
            if (tables.length === 0) {
                alert('No tables available. Please create tables first.');
                return;
            }
            
            renderStatisticsTable();
            statisticsModal.style.display = 'flex';
        }

        // Render statistics table
        function renderStatisticsTable() {
            // Get all unique student names across all tables
            const allStudentNames = [...new Set(
                tables.flatMap(table => table.students.map(student => student.name))
            )].sort();
            
            // Create statistics data structure
            const statisticsData = allStudentNames.map(name => {
                const studentData = { name, totals: [] };
                
                // For each table, find the student's total score
                tables.forEach(table => {
                    const student = table.students.find(s => s.name === name);
                    studentData.totals.push(student ? student.total : 0);
                });
                
                // Calculate overall total
                studentData.overallTotal = studentData.totals.reduce((sum, total) => sum + total, 0);
                
                return studentData;
            });
            
            // Sort by overall total (descending) for positioning
            statisticsData.sort((a, b) => b.overallTotal - a.overallTotal);
            
            // Assign positions
            let currentPosition = 1;
            let previousTotal = null;
            
            statisticsData.forEach((student, index) => {
                if (previousTotal !== null && student.overallTotal === previousTotal) {
                    student.position = currentPosition;
                } else {
                    currentPosition = index + 1;
                    student.position = currentPosition;
                }
                previousTotal = student.overallTotal;
            });
            
            // Create the statistics table
            statisticsContainer.innerHTML = '';
            
            if (allStudentNames.length === 0) {
                statisticsContainer.innerHTML = '<p>No student data available.</p>';
                return;
            }
            
            const statsTable = document.createElement('table');
            statsTable.style.width = '100%';
            
            // Create header row
            const headerRow = document.createElement('tr');
            const nameHeader = document.createElement('th');
            nameHeader.textContent = 'NAMES';
            headerRow.appendChild(nameHeader);
            
            // Add table name headers
            tables.forEach(table => {
                const tableHeader = document.createElement('th');
                tableHeader.textContent = table.name;
                tableHeader.className = 'numeric';
                headerRow.appendChild(tableHeader);
            });
            
            // Add totals and position headers
            const totalsHeader = document.createElement('th');
            totalsHeader.textContent = 'TOTALS';
            totalsHeader.className = 'numeric';
            headerRow.appendChild(totalsHeader);
            
            const positionHeader = document.createElement('th');
            positionHeader.textContent = 'POSITION';
            positionHeader.className = 'position-cell';
            headerRow.appendChild(positionHeader);
            
            statsTable.appendChild(headerRow);
            
            // Create data rows
            statisticsData.forEach(student => {
                const row = document.createElement('tr');
                
                // Name cell (clickable)
                const nameCell = document.createElement('td');
                const nameSpan = document.createElement('span');
                nameSpan.textContent = student.name;
                nameSpan.className = 'clickable-name';
                nameSpan.addEventListener('click', () => showTerminalReport(student.name));
                nameCell.appendChild(nameSpan);
                row.appendChild(nameCell);
                
                // Table score cells
                student.totals.forEach(total => {
                    const scoreCell = document.createElement('td');
                    scoreCell.textContent = total;
                    scoreCell.className = 'numeric';
                    row.appendChild(scoreCell);
                });
                
                // Overall total cell
                const totalCell = document.createElement('td');
                totalCell.textContent = student.overallTotal;
                totalCell.className = 'numeric';
                row.appendChild(totalCell);
                
                // Position cell
                const positionCell = document.createElement('td');
                positionCell.textContent = student.position;
                positionCell.className = 'position-cell';
                row.appendChild(positionCell);
                
                statsTable.appendChild(row);
            });
            
            statisticsContainer.appendChild(statsTable);
        }

        // Show terminal report for a student
        function showTerminalReport(studentName) {
            // Close statistics modal first
            statisticsModal.style.display = 'none';
            
            // Generate terminal report
            renderTerminalReport(studentName);
            terminalReportModal.style.display = 'flex';
        }

        // Render terminal report for a student
        function renderTerminalReport(studentName) {
            terminalReportContainer.innerHTML = '';
            
            // Create terminal report container
            const reportDiv = document.createElement('div');
            reportDiv.className = 'terminal-report';
            
            // Create report header
            const headerDiv = document.createElement('div');
            headerDiv.style.textAlign = 'center';
            headerDiv.style.marginBottom = '20px';
            headerDiv.style.paddingBottom = '15px';
            headerDiv.style.borderBottom = '2px solid var(--primary)';
            
            const studentNameHeading = document.createElement('h2');
            studentNameHeading.textContent = `Terminal Report: ${studentName}`;
            studentNameHeading.style.color = 'var(--primary)';
            headerDiv.appendChild(studentNameHeading);
            
            const reportDate = document.createElement('p');
            reportDate.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
            reportDate.style.color = 'var(--gray)';
            headerDiv.appendChild(reportDate);
            
            reportDiv.appendChild(headerDiv);
            
            // Create results table
            const resultsTable = document.createElement('table');
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const headers = ['SUBJECT', 'CAT TOTAL', 'EXAM', 'SUBJECT TOTAL', 'REMARKS'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            resultsTable.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            let grandTotal = 0;
            let totalPossible = 0;
            
            // Add rows for each table (subject)
            tables.forEach(table => {
                const student = table.students.find(s => s.name === studentName);
                if (student) {
                    const row = document.createElement('tr');
                    
                    // Subject name
                    const subjectCell = document.createElement('td');
                    subjectCell.textContent = table.name;
                    row.appendChild(subjectCell);
                    
                    // CAT Total
                    const catTotalCell = document.createElement('td');
                    catTotalCell.textContent = student.catTotal;
                    catTotalCell.className = 'numeric';
                    row.appendChild(catTotalCell);
                    
                    // Exam
                    const examCell = document.createElement('td');
                    examCell.textContent = student.exam;
                    examCell.className = 'numeric';
                    row.appendChild(examCell);
                    
                    // Subject Total
                    const subjectTotalCell = document.createElement('td');
                    subjectTotalCell.textContent = student.total;
                    subjectTotalCell.className = 'numeric';
                    row.appendChild(subjectTotalCell);
                    
                    // Remarks for subject
                    const remarksCell = document.createElement('td');
                    const subjectRemarks = getRemarks(student.total, 100);
                    remarksCell.textContent = subjectRemarks.text;
                    remarksCell.className = `remarks-cell ${subjectRemarks.class}`;
                    row.appendChild(remarksCell);
                    
                    tbody.appendChild(row);
                    
                    // Update grand total
                    grandTotal += student.total;
                    totalPossible += 100; // Each subject is out of 100
                }
            });
            
            // Add grand total row
            const grandTotalRow = document.createElement('tr');
            grandTotalRow.style.fontWeight = 'bold';
            grandTotalRow.style.backgroundColor = '#f1f5fd';
            
            const grandTotalLabelCell = document.createElement('td');
            grandTotalLabelCell.textContent = 'GRAND TOTAL';
            grandTotalLabelCell.colSpan = 3;
            grandTotalRow.appendChild(grandTotalLabelCell);
            
            const grandTotalCell = document.createElement('td');
            grandTotalCell.textContent = grandTotal;
            grandTotalCell.className = 'numeric';
            grandTotalRow.appendChild(grandTotalCell);
            
            const overallRemarksCell = document.createElement('td');
            const overallPercentage = (grandTotal / totalPossible) * 100;
            const overallRemarks = getRemarks(overallPercentage, 100);
            overallRemarksCell.textContent = overallRemarks.text;
            overallRemarksCell.className = `remarks-cell ${overallRemarks.class}`;
            grandTotalRow.appendChild(overallRemarksCell);
            
            tbody.appendChild(grandTotalRow);
            
            resultsTable.appendChild(tbody);
            reportDiv.appendChild(resultsTable);
            
            // Add comments section
            const commentsSection = document.createElement('div');
            commentsSection.className = 'comments-section';
            
            const commentsHeading = document.createElement('h3');
            commentsHeading.textContent = 'Teacher Comments:';
            commentsSection.appendChild(commentsHeading);
            
            const commentsTextarea = document.createElement('textarea');
            commentsTextarea.className = 'comments-textarea';
            commentsTextarea.placeholder = 'Enter teacher comments here...';
            commentsSection.appendChild(commentsTextarea);
            
            reportDiv.appendChild(commentsSection);
            
            // Add action buttons
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'terminal-report-actions';
            
            const printReportBtn = document.createElement('button');
            printReportBtn.className = 'btn-info';
            printReportBtn.innerHTML = 'üñ®Ô∏è Print Report';
            printReportBtn.addEventListener('click', () => printTerminalReport(studentName, commentsTextarea.value));
            
            const closeReportBtn = document.createElement('button');
            closeReportBtn.className = 'btn-secondary';
            closeReportBtn.innerHTML = '‚ùå Close';
            closeReportBtn.addEventListener('click', () => {
                terminalReportModal.style.display = 'none';
            });
            
            actionsDiv.appendChild(printReportBtn);
            actionsDiv.appendChild(closeReportBtn);
            
            reportDiv.appendChild(actionsDiv);
            
            terminalReportContainer.appendChild(reportDiv);
        }

        // Get remarks based on score
        function getRemarks(score, maxScore) {
            const percentage = (score / maxScore) * 100;
            
            if (percentage >= 90) {
                return { text: 'Distinction', class: 'remarks-excellent' };
            } else if (percentage >= 80) {
                return { text: 'Excellent', class: 'remarks-excellent' };
            } else if (percentage >= 70) {
                return { text: 'Very Good', class: 'remarks-very-good' };
            } else if (percentage >= 60) {
                return { text: 'Good', class: 'remarks-good' };
            } else if (percentage >= 50) {
                return { text: 'Pass', class: 'remarks-pass' };
            } else {
                return { text: 'Fail', class: 'remarks-fail' };
            }
        }

        // Print terminal report
        function printTerminalReport(studentName, comments) {
            // Create a print-friendly version of the terminal report
            const printWindow = window.open('', '_blank');
            
            // Get the student data
            let grandTotal = 0;
            let totalPossible = 0;
            let subjectRows = '';
            
            tables.forEach(table => {
                const student = table.students.find(s => s.name === studentName);
                if (student) {
                    const subjectRemarks = getRemarks(student.total, 100);
                    subjectRows += `
                        <tr>
                            <td>${table.name}</td>
                            <td class="numeric">${student.catTotal}</td>
                            <td class="numeric">${student.exam}</td>
                            <td class="numeric">${student.total}</td>
                            <td class="remarks-cell ${subjectRemarks.class}">${subjectRemarks.text}</td>
                        </tr>
                    `;
                    
                    grandTotal += student.total;
                    totalPossible += 100;
                }
            });
            
            const overallPercentage = (grandTotal / totalPossible) * 100;
            const overallRemarks = getRemarks(overallPercentage, 100);
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Terminal Report - ${studentName}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                        }
                        .print-header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 14px;
                            margin-bottom: 20px;
                        }
                        .print-table th, .print-table td {
                            border: 1px solid #ddd;
                            padding: 8px 10px;
                            text-align: left;
                        }
                        .print-table th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        .print-table .numeric {
                            text-align: right;
                        }
                        .print-table .remarks-cell {
                            text-align: center;
                            font-weight: bold;
                        }
                        .remarks-excellent {
                            color: #28a745;
                        }
                        .remarks-very-good {
                            color: #20c997;
                        }
                        .remarks-good {
                            color: #17a2b8;
                        }
                        .remarks-pass {
                            color: #ffc107;
                        }
                        .remarks-fail {
                            color: #dc3545;
                        }
                        .comments-section {
                            margin-top: 20px;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                        }
                        @page {
                            size: A4 portrait;
                            margin: 0.5cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>Terminal Report</h1>
                        <h2>${studentName}</h2>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>SUBJECT</th>
                                <th>CAT TOTAL</th>
                                <th>EXAM</th>
                                <th>SUBJECT TOTAL</th>
                                <th>REMARKS</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${subjectRows}
                            <tr style="font-weight: bold; background-color: #f1f5fd;">
                                <td colspan="3">GRAND TOTAL</td>
                                <td class="numeric">${grandTotal}</td>
                                <td class="remarks-cell ${overallRemarks.class}">${overallRemarks.text}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="comments-section">
                        <h3>Teacher Comments:</h3>
                        <p>${comments || 'No comments provided.'}</p>
                    </div>
                    <div style="margin-top: 20px; font-size: 12px; text-align: center;">
                        School Stamp & Signature: _________________________
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
                // Optional: close the window after printing
                // printWindow.close();
            };
        }

        // Show help modal
        function showHelp() {
            renderHelpContent();
            helpModal.style.display = 'flex';
        }

        // Render help content
        function renderHelpContent() {
            helpContainer.innerHTML = `
                <div class="help-section">
                    <h3>üìã Getting Started</h3>
                    <p>Welcome to the Student Results Manager! This application helps teachers and school administrators manage student grades efficiently.</p>
                    
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4>‚ûï Add New Table</h4>
                            <p>Create a new class or subject table with default student names.</p>
                        </div>
                        <div class="feature-card">
                            <h4>üìù Clone Names</h4>
                            <p>Create a new table with student names from an existing table (marks reset to 0).</p>
                        </div>
                        <div class="feature-card">
                            <h4>‚úèÔ∏è Edit Content</h4>
                            <p>Click on any cell to edit student names or marks. Changes save automatically.</p>
                        </div>
                        <div class="feature-card">
                            <h4>‚ûï Add Student</h4>
                            <p>Add new students to any table using the button at the bottom of each table.</p>
                        </div>
                    </div>
                </div>

                <div class="help-section">
                    <h3>üî¢ Flexible Mark Input</h3>
                    <p>You can enter marks in several formats and they will be automatically converted:</p>
                    <ul>
                        <li><strong>Fractions:</strong> e.g., "45/50" will be converted to the equivalent mark out of the category maximum</li>
                        <li><strong>Percentages:</strong> e.g., "90%" will be converted to 90% of the category maximum</li>
                        <li><strong>Direct numbers:</strong> e.g., "14" will be used directly (if within the allowed maximum)</li>
                    </ul>
                    <p><strong>Examples:</strong></p>
                    <ul>
                        <li>For CAT1 (max 15): "12/15" ‚Üí 12, "80%" ‚Üí 12, "14" ‚Üí 14</li>
                        <li>For EXAM (max 50): "45/50" ‚Üí 45, "90%" ‚Üí 45, "48" ‚Üí 48</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üìä Data Management</h3>
                    <ul>
                        <li><strong>Automatic Saving:</strong> All changes are automatically saved to your browser's storage.</li>
                        <li><strong>Export Data:</strong> Download all your data as a JSON file for backup or transfer.</li>
                        <li><strong>Import Data:</strong> Merge data from JSON files with your existing data:
                            <ul>
                                <li>Tables with the same name will be merged (students updated/added)</li>
                                <li>New tables will be added to your existing data</li>
                                <li>Student records with the same name will be updated</li>
                            </ul>
                        </li>
                        <li><strong>Clear Data:</strong> Remove all tables and start fresh (use with caution!).</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üìà Statistics & Reports</h3>
                    <ul>
                        <li><strong>Statistics View:</strong> See an overview of all students across all tables with their total scores and positions.</li>
                        <li><strong>Terminal Reports:</strong> Click on any student name in the statistics view to generate a detailed report card.</li>
                        <li><strong>Print Reports:</strong> Generate professional A4-sized reports for parent meetings or student records.</li>
                        <li><strong>Automatic Calculations:</strong> CAT totals, overall scores, and positions are calculated automatically.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üñ®Ô∏è Printing</h3>
                    <ul>
                        <li><strong>Table Printing:</strong> Print individual class tables using the print button on each table.</li>
                        <li><strong>Report Printing:</strong> Generate and print professional terminal reports for students.</li>
                        <li><strong>A4 Optimization:</strong> All print outputs are optimized for standard A4 paper size.</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üéØ Grading System</h3>
                    <ul>
                        <li><strong>CAT Marks:</strong> CAT1 (max 15), CAT2 (max 20), CAT3 (max 15)</li>
                        <li><strong>Exam Marks:</strong> Maximum of 50 marks per subject</li>
                        <li><strong>Total Calculation:</strong> CAT Total + Exam = Subject Total (out of 100)</li>
                        <li><strong>Automatic Remarks:</strong>
                            <ul>
                                <li>Distinction: 90% and above</li>
                                <li>Excellent: 80% - 89%</li>
                                <li>Very Good: 70% - 79%</li>
                                <li>Good: 60% - 69%</li>
                                <li>Pass: 50% - 59%</li>
                                <li>Fail: Below 50%</li>
                            </ul>
                        </li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üí° Tips & Best Practices</h3>
                    <ul>
                        <li>Use descriptive table names (e.g., "Mathematics Grade 7" instead of "Class 1")</li>
                        <li>Regularly export your data as backup</li>
                        <li>Use the statistics view to identify students who need extra help</li>
                        <li>Add personalized comments in terminal reports for better parent communication</li>
                        <li>Use the clone feature to create similar classes with the same student roster</li>
                        <li>Take advantage of flexible mark input to enter marks in your preferred format</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h3>üõ†Ô∏è Technical Information</h3>
                    <ul>
                        <li>This app works entirely in your browser - no server required</li>
                        <li>Data is stored locally in your browser's storage</li>
                        <li>Works offline once loaded</li>
                        <li>Compatible with modern browsers (Chrome, Firefox, Safari, Edge)</li>
                        <li>Responsive design works on desktop, tablet, and mobile devices</li>
                        <li>Contact the Author, Sir Mick - +233545800158, for assistance.</li>
                    </ul>
                </div>
            `;
        }

        // Print a specific table
        function printTable(tableId) {
            const table = tables.find(t => t.id === tableId);
            if (!table) return;
            
            // Create a print-friendly version of the table
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${table.name} - Student Results</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 0;
                            padding: 20px;
                        }
                        .print-header {
                            text-align: center;
                            margin-bottom: 20px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 10px;
                        }
                        .print-table {
                            width: 100%;
                            border-collapse: collapse;
                            font-size: 14px;
                        }
                        .print-table th, .print-table td {
                            border: 1px solid #ddd;
                            padding: 8px 10px;
                            text-align: left;
                        }
                        .print-table th {
                            background-color: #f5f5f5;
                            font-weight: bold;
                        }
                        .print-table .numeric {
                            text-align: right;
                        }
                        .print-table .position-cell {
                            text-align: center;
                            font-weight: bold;
                        }
                        @page {
                            size: A4 portrait;
                            margin: 0.5cm;
                        }
                    </style>
                </head>
                <body>
                    <div class="print-header">
                        <h1>${table.name}</h1>
                        <p>Student Results Summary</p>
                    </div>
                    <table class="print-table">
                        <thead>
                            <tr>
                                <th>NAMES</th>
                                <th>CAT1 Marks 15</th>
                                <th>CAT2 Marks 20</th>
                                <th>CAT3 Marks 15</th>
                                <th>CAT Totals 50</th>
                                <th>EXAM Marks 50</th>
                                <th>TOTAL CAT+ EXAM Marks 100</th>
                                <th>POSITION S</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${table.students.map(student => `
                                <tr>
                                    <td>${student.name}</td>
                                    <td class="numeric">${student.cat1}</td>
                                    <td class="numeric">${student.cat2}</td>
                                    <td class="numeric">${student.cat3}</td>
                                    <td class="numeric">${student.catTotal}</td>
                                    <td class="numeric">${student.exam}</td>
                                    <td class="numeric">${student.total}</td>
                                    <td class="position-cell">${student.position}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top: 20px; font-size: 12px; text-align: center;">
                        Generated on ${new Date().toLocaleDateString()}
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load before printing
            printWindow.onload = function() {
                printWindow.print();
                // Optional: close the window after printing
                // printWindow.close();
            };
        }

        // Hide empty state
        function hideEmptyState() {
            emptyState.style.display = 'none';
        }

        // Show empty state
        function showEmptyState() {
            emptyState.style.display = 'block';
        }

        // Export data as JSON
        function exportData() {
            if (tables.length === 0) {
                alert('No data to export. Please add tables first.');
                return;
            }
            
            const dataStr = JSON.stringify({
                tables: tables,
                tableCounter: tableCounter,
                exportedAt: new Date().toISOString()
            }, null, 2);
            
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'student-results-data.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Handle file import with merging
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate imported data structure
                    if (Array.isArray(importedData.tables) && importedData.tables.every(item => 
                        item.id && item.name && Array.isArray(item.students))) {
                        
                        const importSummary = mergeImportedData(importedData);
                        renderTables();
                        hideEmptyState();
                        saveToLocalStorage();
                        
                        // Show import summary
                        showImportSummary(importSummary);
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    alert('Error importing data: Invalid file format');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            // Reset file input
            event.target.value = '';
        }

        // Merge imported data with existing data
        function mergeImportedData(importedData) {
            const summary = {
                tablesAdded: 0,
                tablesUpdated: 0,
                studentsAdded: 0,
                studentsUpdated: 0
            };
            
            // Update table counter to avoid ID conflicts
            const maxExistingId = tables.reduce((max, table) => {
                const idNum = parseInt(table.id.replace('table-', ''));
                return idNum > max ? idNum : max;
            }, 0);
            
            tableCounter = Math.max(tableCounter, maxExistingId + 1);
            
            // Process each imported table
            importedData.tables.forEach(importedTable => {
                // Check if table with same name exists
                const existingTable = tables.find(t => t.name === importedTable.name);
                
                if (existingTable) {
                    // Merge students into existing table
                    summary.tablesUpdated++;
                    
                    importedTable.students.forEach(importedStudent => {
                        const existingStudent = existingTable.students.find(s => s.name === importedStudent.name);
                        
                        if (existingStudent) {
                            // Update existing student
                            Object.assign(existingStudent, importedStudent);
                            summary.studentsUpdated++;
                        } else {
                            // Add new student
                            existingTable.students.push(importedStudent);
                            summary.studentsAdded++;
                        }
                    });
                    
                    // Update positions for the merged table
                    updatePositions(existingTable.id);
                } else {
                    // Add new table
                    // Generate new ID to avoid conflicts
                    const newTableId = `table-${tableCounter++}`;
                    importedTable.id = newTableId;
                    tables.push(importedTable);
                    summary.tablesAdded++;
                    summary.studentsAdded += importedTable.students.length;
                }
            });
            
            return summary;
        }

        // Show import summary
        function showImportSummary(summary) {
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'import-summary';
            
            summaryDiv.innerHTML = `
                <h4>‚úÖ Data Import Successful</h4>
                <ul>
                    <li>Tables added: ${summary.tablesAdded}</li>
                    <li>Tables updated: ${summary.tablesUpdated}</li>
                    <li>Students added: ${summary.studentsAdded}</li>
                    <li>Students updated: ${summary.studentsUpdated}</li>
                </ul>
                <p>Your data has been merged successfully. All changes have been saved automatically.</p>
            `;
            
            // Insert at the top of the tables container
            tablesContainer.insertBefore(summaryDiv, tablesContainer.firstChild);
            
            // Remove the summary after 5 seconds
            setTimeout(() => {
                if (summaryDiv.parentNode) {
                    summaryDiv.parentNode.removeChild(summaryDiv);
                }
            }, 5000);
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>