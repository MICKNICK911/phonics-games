<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Results Manager</title>
    <style>
        /* Your existing CSS remains the same */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        h1 {
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #3aacd6;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d11467;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e0861b;
        }

        .btn-info {
            background-color: #7209b7;
            color: white;
        }

        .btn-info:hover {
            background-color: #5a08a0;
        }

        .btn-secondary {
            background-color: var(--gray);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-help {
            background-color: #f8961e;
            color: white;
        }

        .btn-help:hover {
            background-color: #e0861b;
        }

        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary);
            color: white;
        }

        .table-title {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            transition: all 0.2s;
            cursor: text;
        }

        .table-title:focus {
            background-color: white;
            color: var(--dark);
            outline: none;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        th {
            background-color: #f1f5fd;
            font-weight: 600;
            color: var(--primary);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f9fafc;
        }

        .editable {
            outline: none;
            border: 1px solid transparent;
            padding: 5px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            width: 100%;
            text-align: center;
        }

        .editable:focus {
            border-color: var(--primary-light);
            background-color: #f0f4ff;
        }

        .position-cell {
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            color: var(--gray);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .saved-indicator {
            color: var(--success);
        }

        .input-hint {
            font-size: 0.75rem;
            color: var(--gray);
            margin-top: 3px;
            font-style: italic;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background-color: var(--primary);
            color: white;
            border-radius: 10px 10px 0 0;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 20px;
        }

        /* Clickable student names in statistics */
        .clickable-name {
            color: var(--primary);
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.2s;
        }

        .clickable-name:hover {
            color: var(--secondary);
        }

        /* Terminal report styles */
        .terminal-report {
            width: 100%;
        }

        .terminal-report table {
            width: 100%;
            margin-bottom: 20px;
        }

        .terminal-report th {
            background-color: #f1f5fd;
        }

        .terminal-report .remarks-cell {
            font-weight: 600;
            text-align: center;
        }

        .remarks-excellent {
            color: #28a745;
        }

        .remarks-very-good {
            color: #20c997;
        }

        .remarks-good {
            color: #17a2b8;
        }

        .remarks-pass {
            color: #ffc107;
        }

        .remarks-fail {
            color: #dc3545;
        }

        .comments-section {
            margin-top: 20px;
        }

        .comments-section h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .comments-textarea {
            width: 100%;
            min-height: 120px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
        }

        .terminal-report-actions {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        /* CAT Configuration styles */
        .cat-config {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            background-color: #f8f9fa;
        }

        .cat-config-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .cat-config-title {
            font-weight: 600;
            color: var(--primary);
        }

        .cat-columns-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .cat-column-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .cat-column-name {
            font-weight: 600;
        }

        .cat-column-max {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .cat-column-actions {
            display: flex;
            gap: 5px;
        }

        .cat-column-actions button {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .add-cat-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .add-cat-form input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }

        .add-cat-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .cat-name-input {
            min-width: 120px;
        }

        .cat-max-input {
            width: 80px;
        }

        /* Help content styles */
        .help-section {
            margin-bottom: 25px;
        }

        .help-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid var(--border);
            text-align: center;
        }

        .help-section ul {
            padding-left: 20px;
        }

        .help-section li {
            margin-bottom: 8px;
        }

        .help-section code {
            background-color: #f1f5fd;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .feature-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid var(--primary);
            text-align: center;
        }

        .feature-card h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        /* Import summary styles */
        .import-summary {
            background-color: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
            text-align: center;
        }

        .import-summary h4 {
            color: #155724;
            margin-bottom: 10px;
        }

        .import-summary ul {
            padding-left: 20px;
            text-align: left;
            display: inline-block;
        }

        .import-summary li {
            margin-bottom: 5px;
        }

        /* Bulk operations styles */
        .bulk-list-item {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bulk-list-item:hover {
            background-color: #f1f5fd;
            border-color: var(--primary-light);
        }

        .bulk-list-item.active {
            background-color: #e8f4ff;
            border-color: var(--primary);
        }

        .bulk-list-item-info {
            flex: 1;
        }

        .bulk-list-item-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .bulk-list-item-details {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .bulk-list-item-actions {
            display: flex;
            gap: 5px;
        }

        .bulk-list-item-actions button {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        /* Current dataset indicator */
        .current-dataset {
            background-color: var(--primary);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-table, .print-table * {
                visibility: visible;
            }
            
            .print-table {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                font-size: 14px;
            }
            
            .print-table table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .print-table th, 
            .print-table td {
                padding: 8px 10px;
                border: 1px solid #ddd;
                text-align: center;
            }
            
            .print-table th {
                background-color: #f1f5fd;
            }
            
            .no-print {
                display: none !important;
            }
            
            @page {
                size: A4 portrait;
                margin: 0.5cm;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .table-container {
                overflow-x: auto;
            }
            
            table {
                min-width: 800px;
            }
            
            .feature-grid {
                grid-template-columns: 1fr;
            }
            
            .cat-config-header {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .add-cat-form {
                flex-direction: column;
                align-items: center;
            }
            
            .add-cat-form input {
                width: 100%;
            }
            
            .bulk-list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .bulk-list-item-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Student Results Manager 
                <span id="currentDatasetIndicator" class="current-dataset" style="display: none;">
                    <span id="currentDatasetName">Default</span>
                </span>
            </h1>
            <div>
                <div class="controls">
                    <button id="addTableBtn" class="btn-primary">üìã Add New Table</button>
                    <button id="importBtn" class="btn-success">üìÅ Import Data</button>
                    <button id="exportBtn" class="btn-warning">üíæ Export Data</button>
                    <button id="statisticsBtn" class="btn-info">üìà Statistics</button>
                    <button id="helpBtn" class="btn-help">‚ùì Help</button>
                    <button id="bulkImportBtn" class="btn-success">üìö Bulk Import</button>
                    <button id="bulkExportBtn" class="btn-warning">üì¶ Bulk Export</button>
                    <button id="bulkListBtn" class="btn-info">üìã Bulk List</button>
                    <button id="clearDataBtn" class="btn-danger">üóëÔ∏è Clear All Data</button>
                    <button id="reloadBtn" class="btn-secondary">üîÑ Reload Page</button>
                </div>
                <div class="status-indicator" id="statusIndicator">
                    <span id="saveStatus">All changes saved</span>
                </div>
            </div>
        </header>

        <main id="tablesContainer">
            <!-- Tables will be dynamically added here -->
            <div class="empty-state" id="emptyState">
                <p>No tables created yet. Click "Add New Table" to get started.</p>
                <button id="initialAddTable" class="btn-primary">üìã Create First Table</button>
            </div>
        </main>

        <footer class="footer">
            <p>Student Results Manager &copy; 2023 | Developed by Sir Mick | Contact: 0545800158</p>
            <p class="input-hint">Tip: You can enter marks in any format (e.g., 45/50, 90%, 14) and they will be converted automatically</p>
        </footer>
    </div>

    <input type="file" id="fileInput" class="file-input" accept=".json">
    <input type="file" id="bulkFileInput" class="file-input" accept=".json" multiple>

    <!-- Statistics Modal -->
    <div id="statisticsModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìä Overall Statistics</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="statisticsContainer">
                    <!-- Statistics table will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Terminal Report Modal -->
    <div id="terminalReportModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìù Student Terminal Report</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="terminalReportContainer">
                    <!-- Terminal report will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚ùì Student Results Manager - Help Guide</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="helpContainer">
                    <!-- Help content will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk List Modal -->
    <div id="bulkListModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üìã Results Datasets</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="bulkListContainer">
                    <!-- Bulk list will be rendered here -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button id="createNewDatasetBtn" class="btn-primary">‚ûï Create New Dataset</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let resultDatasets = [];
        let currentDatasetId = null;
        let tableCounter = 1;
        let saveTimeout = null;
        const STORAGE_KEY = 'studentResultsDataV2';

        // DOM elements
        const reloadBtn = document.getElementById('reloadBtn');
        const tablesContainer = document.getElementById('tablesContainer');
        const emptyState = document.getElementById('emptyState');
        const addTableBtn = document.getElementById('addTableBtn');
        const initialAddTableBtn = document.getElementById('initialAddTable');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const statisticsBtn = document.getElementById('statisticsBtn');
        const helpBtn = document.getElementById('helpBtn');
        const bulkImportBtn = document.getElementById('bulkImportBtn');
        const bulkExportBtn = document.getElementById('bulkExportBtn');
        const bulkListBtn = document.getElementById('bulkListBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const fileInput = document.getElementById('fileInput');
        const bulkFileInput = document.getElementById('bulkFileInput');
        const saveStatus = document.getElementById('saveStatus');
        const statisticsModal = document.getElementById('statisticsModal');
        const terminalReportModal = document.getElementById('terminalReportModal');
        const helpModal = document.getElementById('helpModal');
        const bulkListModal = document.getElementById('bulkListModal');
        const closeModalBtns = document.querySelectorAll('.close-modal');
        const statisticsContainer = document.getElementById('statisticsContainer');
        const terminalReportContainer = document.getElementById('terminalReportContainer');
        const helpContainer = document.getElementById('helpContainer');
        const bulkListContainer = document.getElementById('bulkListContainer');
        const createNewDatasetBtn = document.getElementById('createNewDatasetBtn');
        const currentDatasetIndicator = document.getElementById('currentDatasetIndicator');
        const currentDatasetName = document.getElementById('currentDatasetName');

        // Sample data for initial table
        const initialStudents = [
            "Student 1", "Student 2", "Student 3", "Student 4", "Student 5", 
            "Student 6", "Student 7", "Student 8", "Student 9", "Student 10"
        ];

        // Default CAT columns configuration
        const defaultCatColumns = [
            { id: 'cat1', name: 'CAT1', maxScore: 15 },
            { id: 'cat2', name: 'CAT2', maxScore: 20 },
            { id: 'cat3', name: 'CAT3', maxScore: 15 }
        ];

        // Event listeners
        reloadBtn.addEventListener('click', reloadPage);
        addTableBtn.addEventListener('click', addNewTable);
        initialAddTableBtn.addEventListener('click', addNewTable);
        importBtn.addEventListener('click', () => fileInput.click());
        exportBtn.addEventListener('click', exportData);
        statisticsBtn.addEventListener('click', showStatistics);
        helpBtn.addEventListener('click', showHelp);
        bulkImportBtn.addEventListener('click', () => bulkFileInput.click());
        bulkExportBtn.addEventListener('click', bulkExportData);
        bulkListBtn.addEventListener('click', showBulkList);
        createNewDatasetBtn.addEventListener('click', createNewDataset);
        clearDataBtn.addEventListener('click', clearAllData);
        fileInput.addEventListener('change', handleFileImport);
        bulkFileInput.addEventListener('change', handleBulkFileImport);
        
        // Close modal events
        closeModalBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const modal = e.target.closest('.modal-overlay');
                if (modal) modal.style.display = 'none';
            });
        });

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        });

        // Initialize app
        function init() {
            loadFromLocalStorage();
            
            // If no datasets exist, create a default one
            if (resultDatasets.length === 0) {
                createDefaultDataset();
            }
            
            // Set current dataset if not set
            if (!currentDatasetId && resultDatasets.length > 0) {
                currentDatasetId = resultDatasets[0].id;
            }
            
            updateCurrentDatasetIndicator();
            renderCurrentDataset();
        }

        // Get the current dataset
        function getCurrentDataset() {
            return resultDatasets.find(dataset => dataset.id === currentDatasetId);
        }

        // Get the current tables
        function getCurrentTables() {
            const dataset = getCurrentDataset();
            return dataset ? dataset.tables : [];
        }

        // Update current dataset indicator
        function updateCurrentDatasetIndicator() {
            const dataset = getCurrentDataset();
            if (dataset) {
                currentDatasetName.textContent = dataset.name;
                currentDatasetIndicator.style.display = 'inline-flex';
            } else {
                currentDatasetIndicator.style.display = 'none';
            }
        }

        // Create default dataset
        function createDefaultDataset() {
            const datasetId = generateId();
            resultDatasets.push({
                id: datasetId,
                name: 'Default Dataset',
                tables: [],
                tableCounter: 1
            });
            currentDatasetId = datasetId;
        }

        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // Handle migration from v1 to v2
                    if (parsedData.tables !== undefined) {
                        // This is v1 data, migrate to v2 format
                        const datasetId = generateId();
                        resultDatasets = [{
                            id: datasetId,
                            name: 'Migrated Dataset',
                            tables: parsedData.tables || [],
                            tableCounter: parsedData.tableCounter || 1
                        }];
                        currentDatasetId = datasetId;
                        
                        console.log('Migrated data from v1 to v2 format');
                    } else {
                        // This is v2 data
                        resultDatasets = parsedData.resultDatasets || [];
                        currentDatasetId = parsedData.currentDatasetId || null;
                    }
                    
                    console.log('Data loaded from localStorage');
                    
                    // Ensure all datasets and tables have proper structure
                    resultDatasets.forEach(dataset => {
                        if (!dataset.tables) dataset.tables = [];
                        if (!dataset.tableCounter) dataset.tableCounter = 1;
                        
                        dataset.tables.forEach(table => {
                            if (!table.catColumns) {
                                table.catColumns = [...defaultCatColumns];
                            }
                            table.students.forEach(student => {
                                if (!student.catMarks) {
                                    student.catMarks = {};
                                    table.catColumns.forEach(cat => {
                                        student.catMarks[cat.id] = student[cat.id] || 0;
                                    });
                                }
                                // Ensure catTotal and total are calculated
                                recalculateStudentTotals(table, student);
                            });
                            updatePositions(table.id);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                resultDatasets = [];
                currentDatasetId = null;
            }
        }

        // Save data to localStorage with debouncing
        function saveToLocalStorage() {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            
            saveStatus.textContent = 'Saving...';
            saveStatus.className = '';
            
            saveTimeout = setTimeout(() => {
                try {
                    const dataToSave = {
                        resultDatasets: resultDatasets,
                        currentDatasetId: currentDatasetId,
                        lastSaved: new Date().toISOString()
                    };
                    
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                    
                    saveStatus.textContent = 'All changes saved';
                    saveStatus.className = 'saved-indicator';
                    
                    console.log('Data saved to localStorage');
                } catch (error) {
                    console.error('Error saving data to localStorage:', error);
                    saveStatus.textContent = 'Error saving data';
                    saveStatus.className = '';
                }
            }, 500);
        }

        // Parse mark input and convert to appropriate scale
        function parseMarkInput(input, maxMark) {
            if (input === '' || input === null || input === undefined) {
                return 0;
            }
            
            const strInput = String(input).trim();
            
            // Handle fraction format (e.g., "45/50")
            if (strInput.includes('/')) {
                const parts = strInput.split('/');
                if (parts.length === 2) {
                    const numerator = parseFloat(parts[0]);
                    const denominator = parseFloat(parts[1]);
                    
                    if (!isNaN(numerator) && !isNaN(denominator) && denominator !== 0) {
                        const percentage = numerator / denominator;
                        const convertedMark = percentage * maxMark;
                        return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                    }
                }
            }
            
            // Handle percentage format (e.g., "90%")
            if (strInput.includes('%')) {
                const percentage = parseFloat(strInput);
                if (!isNaN(percentage)) {
                    const convertedMark = (percentage / 100) * maxMark;
                    return Math.min(Math.max(Math.round(convertedMark), 0), maxMark);
                }
            }
            
            // Handle decimal numbers
            const numValue = parseFloat(strInput);
            if (!isNaN(numValue)) {
                if (numValue > maxMark) {
                    return maxMark;
                }
                return Math.min(Math.max(Math.round(numValue), 0), maxMark);
            }
            
            return 0;
        }

        // Create a new table
        function addNewTable() {
            const dataset = getCurrentDataset();
            if (!dataset) return;
            
            const tableId = `table-${dataset.tableCounter++}`;
            
            const students = initialStudents.map(name => {
                const student = {
                    name,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0,
                    catMarks: {}
                };
                
                defaultCatColumns.forEach(cat => {
                    student.catMarks[cat.id] = 0;
                });
                
                return student;
            });
            
            const tableData = {
                id: tableId,
                name: `Class ${dataset.tableCounter - 1}`,
                catColumns: JSON.parse(JSON.stringify(defaultCatColumns)),
                students: students
            };
            
            dataset.tables.push(tableData);
            renderCurrentDataset();
            hideEmptyState();
            saveToLocalStorage();
        }

        // Create a new table with names from an existing table
        function createTableFromNames(sourceTableId) {
            const dataset = getCurrentDataset();
            if (!dataset) return;
            
            const sourceTable = dataset.tables.find(t => t.id === sourceTableId);
            if (!sourceTable) return;
            
            const tableId = `table-${dataset.tableCounter++}`;
            
            const students = sourceTable.students.map(student => {
                const newStudent = {
                    name: student.name,
                    exam: 0,
                    catTotal: 0,
                    total: 0,
                    position: 0,
                    catMarks: {}
                };
                
                sourceTable.catColumns.forEach(cat => {
                    newStudent.catMarks[cat.id] = 0;
                });
                
                return newStudent;
            });
            
            const tableData = {
                id: tableId,
                name: `${sourceTable.name} (Copy)`,
                catColumns: JSON.parse(JSON.stringify(sourceTable.catColumns)),
                students: students
            };
            
            dataset.tables.push(tableData);
            renderCurrentDataset();
            hideEmptyState();
            saveToLocalStorage();
        }

        // Render the current dataset
        function renderCurrentDataset() {
            tablesContainer.innerHTML = '';
            
            const dataset = getCurrentDataset();
            if (!dataset) {
                showEmptyState();
                return;
            }
            
            if (dataset.tables.length === 0) {
                showEmptyState();
                return;
            }
            
            hideEmptyState();
            
            dataset.tables.forEach(tableData => {
                const tableElement = createTableElement(tableData);
                tablesContainer.appendChild(tableElement);
            });
            
            dataset.tables.forEach(table => updatePositions(table.id));
        }
            
            // Create table HTML element
function createTableElement(tableData) {
    const tableContainer = document.createElement('div');
    tableContainer.className = 'table-container';
    tableContainer.id = tableData.id;
    
    // Table header with title and actions
    const tableHeader = document.createElement('div');
    tableHeader.className = 'table-header';
    
    const tableTitle = document.createElement('div');
    tableTitle.className = 'table-title';
    tableTitle.setAttribute('contenteditable', 'true');
    tableTitle.textContent = tableData.name;
    tableTitle.addEventListener('blur', (e) => {
        updateTableName(tableData.id, e.target.textContent);
    });
    tableTitle.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            tableTitle.blur();
        }
    });
    
    const tableActions = document.createElement('div');
    tableActions.className = 'table-actions';
    
    const printBtn = document.createElement('button');
    printBtn.className = 'btn-info';
    printBtn.innerHTML = 'üñ®Ô∏è Print';
    printBtn.addEventListener('click', () => printTable(tableData.id));
    
    const cloneBtn = document.createElement('button');
    cloneBtn.className = 'btn-secondary';
    cloneBtn.innerHTML = 'üìù Clone Names';
    cloneBtn.title = 'Create new table with these names';
    cloneBtn.addEventListener('click', () => createTableFromNames(tableData.id));
    
    const renameBtn = document.createElement('button');
    renameBtn.className = 'btn-success';
    renameBtn.innerHTML = '‚úèÔ∏è Edit Name';
    renameBtn.addEventListener('click', () => {
        tableTitle.focus();
        const range = document.createRange();
        range.selectNodeContents(tableTitle);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    });
    
    const deleteBtn = document.createElement('button');
    deleteBtn.className = 'btn-danger';
    deleteBtn.innerHTML = 'üóëÔ∏è Delete';
    deleteBtn.addEventListener('click', () => deleteTable(tableData.id));
    
    tableActions.appendChild(printBtn);
    tableActions.appendChild(cloneBtn);
    tableActions.appendChild(renameBtn);
    tableActions.appendChild(deleteBtn);
    
    tableHeader.appendChild(tableTitle);
    tableHeader.appendChild(tableActions);
    
    // CAT Configuration section
    const catConfigSection = document.createElement('div');
    catConfigSection.className = 'cat-config';
    
    const catConfigHeader = document.createElement('div');
    catConfigHeader.className = 'cat-config-header';
    
    const catConfigTitle = document.createElement('div');
    catConfigTitle.className = 'cat-config-title';
    catConfigTitle.textContent = 'CAT Columns Configuration';
    catConfigHeader.appendChild(catConfigTitle);
    
    const addCatBtn = document.createElement('button');
    addCatBtn.className = 'btn-primary';
    addCatBtn.innerHTML = '‚ûï Add CAT Column';
    addCatBtn.addEventListener('click', () => showAddCatForm(tableData.id));
    catConfigHeader.appendChild(addCatBtn);
    
    catConfigSection.appendChild(catConfigHeader);
    
    // CAT columns list
    const catColumnsList = document.createElement('div');
    catColumnsList.className = 'cat-columns-list';
    
    tableData.catColumns.forEach((catColumn, index) => {
        const catColumnItem = document.createElement('div');
        catColumnItem.className = 'cat-column-item';
        
        const catColumnName = document.createElement('span');
        catColumnName.className = 'cat-column-name';
        catColumnName.textContent = catColumn.name;
        
        const catColumnMax = document.createElement('span');
        catColumnMax.className = 'cat-column-max';
        catColumnMax.textContent = `Max: ${catColumn.maxScore}`;
        
        const catColumnActions = document.createElement('div');
        catColumnActions.className = 'cat-column-actions';
        
        const editBtn = document.createElement('button');
        editBtn.className = 'btn-secondary';
        editBtn.innerHTML = '‚úèÔ∏è';
        editBtn.title = 'Edit CAT Column';
        editBtn.addEventListener('click', () => editCatColumn(tableData.id, index));
        
        const deleteCatBtn = document.createElement('button');
        deleteCatBtn.className = 'btn-danger';
        deleteCatBtn.innerHTML = 'üóëÔ∏è';
        deleteCatBtn.title = 'Delete CAT Column';
        deleteCatBtn.addEventListener('click', () => deleteCatColumn(tableData.id, index));
        
        catColumnActions.appendChild(editBtn);
        catColumnActions.appendChild(deleteCatBtn);
        
        catColumnItem.appendChild(catColumnName);
        catColumnItem.appendChild(catColumnMax);
        catColumnItem.appendChild(catColumnActions);
        
        catColumnsList.appendChild(catColumnItem);
    });
    
    catConfigSection.appendChild(catColumnsList);
    
    // Add CAT form (initially hidden)
    const addCatForm = document.createElement('div');
    addCatForm.className = 'add-cat-form';
    addCatForm.id = `add-cat-form-${tableData.id}`;
    addCatForm.style.display = 'none';
    
    const catNameInput = document.createElement('input');
    catNameInput.type = 'text';
    catNameInput.className = 'cat-name-input';
    catNameInput.placeholder = 'CAT Name';
    
    const catMaxInput = document.createElement('input');
    catMaxInput.type = 'number';
    catMaxInput.className = 'cat-max-input';
    catMaxInput.placeholder = 'Max Score';
    catMaxInput.min = '1';
    catMaxInput.value = '10';
    
    const saveCatBtn = document.createElement('button');
    saveCatBtn.className = 'btn-success';
    saveCatBtn.innerHTML = 'üíæ Save';
    saveCatBtn.addEventListener('click', () => {
        addCatColumn(tableData.id, catNameInput.value, parseInt(catMaxInput.value));
        hideAddCatForm(tableData.id);
    });
    
    const cancelCatBtn = document.createElement('button');
    cancelCatBtn.className = 'btn-secondary';
    cancelCatBtn.innerHTML = '‚ùå Cancel';
    cancelCatBtn.addEventListener('click', () => hideAddCatForm(tableData.id));
    
    addCatForm.appendChild(catNameInput);
    addCatForm.appendChild(catMaxInput);
    addCatForm.appendChild(saveCatBtn);
    addCatForm.appendChild(cancelCatBtn);
    
    catConfigSection.appendChild(addCatForm);
    
    // Create the table
    const table = document.createElement('table');
    
    // Table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    // Name header
    const nameHeader = document.createElement('th');
    nameHeader.textContent = 'NAMES';
    headerRow.appendChild(nameHeader);
    
    // CAT column headers
    tableData.catColumns.forEach(catColumn => {
        const catHeader = document.createElement('th');
        catHeader.textContent = `${catColumn.name} Marks ${catColumn.maxScore}`;
        headerRow.appendChild(catHeader);
    });
    
    // CAT Total header
    const catTotalHeader = document.createElement('th');
    catTotalHeader.textContent = 'CAT Totals 50';
    headerRow.appendChild(catTotalHeader);
    
    // Exam header
    const examHeader = document.createElement('th');
    examHeader.textContent = 'EXAM Marks 50';
    headerRow.appendChild(examHeader);
    
    // Total header
    const totalHeader = document.createElement('th');
    totalHeader.textContent = 'TOTAL CAT+ EXAM Marks 100';
    headerRow.appendChild(totalHeader);
    
    // Position header
    const positionHeader = document.createElement('th');
    positionHeader.textContent = 'POSITION S';
    headerRow.appendChild(positionHeader);
    
    // Actions header
    const actionsHeader = document.createElement('th');
    actionsHeader.textContent = 'ACTIONS';
    headerRow.appendChild(actionsHeader);
    
    thead.appendChild(headerRow);
    table.appendChild(thead);
    
    // Table body
    const tbody = document.createElement('tbody');
    
    tableData.students.forEach((student, index) => {
        const row = document.createElement('tr');
        
        // Name cell
        const nameCell = document.createElement('td');
        const nameInput = document.createElement('span');
        nameInput.className = 'editable';
        nameInput.textContent = student.name;
        nameInput.setAttribute('contenteditable', 'true');
        nameInput.addEventListener('blur', (e) => {
            updateStudentName(tableData.id, index, e.target.textContent);
        });
        nameCell.appendChild(nameInput);
        row.appendChild(nameCell);
        
        // CAT column cells
        tableData.catColumns.forEach(catColumn => {
            const catCell = document.createElement('td');
            const catInput = document.createElement('span');
            catInput.className = 'editable';
            catInput.textContent = student.catMarks[catColumn.id] || 0;
            catInput.setAttribute('contenteditable', 'true');
            catInput.addEventListener('blur', (e) => {
                const convertedMark = parseMarkInput(e.target.textContent, catColumn.maxScore);
                updateStudentCatMark(tableData.id, index, catColumn.id, convertedMark);
            });
            catCell.appendChild(catInput);
            row.appendChild(catCell);
        });
        
        // CAT Total cell (calculated)
        const catTotalCell = document.createElement('td');
        catTotalCell.textContent = student.catTotal;
        row.appendChild(catTotalCell);
        
        // EXAM cell
        const examCell = document.createElement('td');
        const examInput = document.createElement('span');
        examInput.className = 'editable';
        examInput.textContent = student.exam;
        examInput.setAttribute('contenteditable', 'true');
        examInput.addEventListener('blur', (e) => {
            const convertedMark = parseMarkInput(e.target.textContent, 50);
            updateStudentMark(tableData.id, index, 'exam', convertedMark);
        });
        examCell.appendChild(examInput);
        row.appendChild(examCell);
        
        // TOTAL cell (calculated)
        const totalCell = document.createElement('td');
        totalCell.textContent = student.total;
        row.appendChild(totalCell);
        
        // POSITION cell (calculated)
        const positionCell = document.createElement('td');
        positionCell.className = 'position-cell';
        positionCell.textContent = student.position;
        row.appendChild(positionCell);
        
        // Add row actions
        const actionsCell = document.createElement('td');
        const deleteStudentBtn = document.createElement('button');
        deleteStudentBtn.className = 'btn-danger';
        deleteStudentBtn.innerHTML = 'üóëÔ∏è';
        deleteStudentBtn.title = 'Delete Student';
        deleteStudentBtn.addEventListener('click', () => deleteStudent(tableData.id, index));
        
        actionsCell.appendChild(deleteStudentBtn);
        row.appendChild(actionsCell);
        
        tbody.appendChild(row);
    });
    
    table.appendChild(tbody);
    
    // Add student button
    const addStudentRow = document.createElement('div');
    addStudentRow.style.padding = '15px 20px';
    addStudentRow.style.borderTop = '1px solid var(--border)';
    addStudentRow.style.textAlign = 'center';
    
    const addStudentBtn = document.createElement('button');
    addStudentBtn.className = 'btn-primary';
    addStudentBtn.innerHTML = '‚ûï Add Student';
    addStudentBtn.addEventListener('click', () => addStudent(tableData.id));
    
    addStudentRow.appendChild(addStudentBtn);
    
    tableContainer.appendChild(tableHeader);
    tableContainer.appendChild(catConfigSection);
    tableContainer.appendChild(table);
    tableContainer.appendChild(addStudentRow);
    
    return tableContainer;
}

// Show add CAT form
function showAddCatForm(tableId) {
    const form = document.getElementById(`add-cat-form-${tableId}`);
    if (form) {
        form.style.display = 'flex';
        // Focus the name input
        const nameInput = form.querySelector('.cat-name-input');
        if (nameInput) nameInput.focus();
    }
}

// Hide add CAT form
function hideAddCatForm(tableId) {
    const form = document.getElementById(`add-cat-form-${tableId}`);
    if (form) {
        form.style.display = 'none';
        const nameInput = form.querySelector('.cat-name-input');
        const maxInput = form.querySelector('.cat-max-input');
        if (nameInput) nameInput.value = '';
        if (maxInput) maxInput.value = '10';
    }
}

// Add a new CAT column
function addCatColumn(tableId, name, maxScore) {
    if (!name || !maxScore || maxScore <= 0) {
        alert('Please enter a valid name and maximum score (greater than 0)');
        return;
    }
    
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (!table) return;
    
    // Check if a CAT column with this name already exists
    if (table.catColumns.some(cat => cat.name === name)) {
        alert('A CAT column with this name already exists');
        return;
    }
    
    // Generate a unique ID for the CAT column
    const id = `cat-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Add the new CAT column
    table.catColumns.push({
        id: id,
        name: name,
        maxScore: maxScore
    });
    
    // Add the new CAT column to all students
    table.students.forEach(student => {
        student.catMarks[id] = 0;
    });
    
    // Recalculate totals and positions
    table.students.forEach((student) => {
        recalculateStudentTotals(table, student);
    });
    updatePositions(tableId);
    
    // Re-render the table
    renderCurrentDataset();
    saveToLocalStorage();
}

// Edit CAT column
function editCatColumn(tableId, catIndex) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (!table || !table.catColumns[catIndex]) return;
    
    const catColumn = table.catColumns[catIndex];
    
    const newName = prompt('Enter new name for CAT column:', catColumn.name);
    if (newName === null) return;
    
    const newMaxScore = parseInt(prompt('Enter new maximum score:', catColumn.maxScore));
    if (isNaN(newMaxScore) || newMaxScore <= 0) {
        alert('Please enter a valid maximum score (greater than 0)');
        return;
    }
    
    // Update CAT column
    const oldMaxScore = catColumn.maxScore;
    catColumn.name = newName;
    catColumn.maxScore = newMaxScore;
    
    // Recalculate marks if max score changed
    if (newMaxScore !== oldMaxScore) {
        table.students.forEach(student => {
            const currentMark = student.catMarks[catColumn.id];
            if (currentMark > newMaxScore) {
                student.catMarks[catColumn.id] = newMaxScore;
            }
        });
    }
    
    // Recalculate totals and positions
    table.students.forEach((student) => {
        recalculateStudentTotals(table, student);
    });
    updatePositions(tableId);
    
    // Re-render the table
    renderCurrentDataset();
    saveToLocalStorage();
}

// Delete CAT column
function deleteCatColumn(tableId, catIndex) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (!table || !table.catColumns[catIndex]) return;
    
    const catColumn = table.catColumns[catIndex];
    
    if (!confirm(`Are you sure you want to delete the "${catColumn.name}" CAT column? This action cannot be undone.`)) {
        return;
    }
    
    // Remove the CAT column
    table.catColumns.splice(catIndex, 1);
    
    // Remove the CAT column from all students
    table.students.forEach(student => {
        delete student.catMarks[catColumn.id];
    });
    
    // Recalculate totals and positions
    table.students.forEach((student) => {
        recalculateStudentTotals(table, student);
    });
    updatePositions(tableId);
    
    // Re-render the table
    renderCurrentDataset();
    saveToLocalStorage();
}

// Recalculate totals for a student
function recalculateStudentTotals(table, student) {
    // Calculate CAT total (sum of all CAT marks)
    student.catTotal = table.catColumns.reduce((sum, cat) => {
        return sum + (student.catMarks[cat.id] || 0);
    }, 0);
    
    // Ensure CAT total doesn't exceed 50
    student.catTotal = Math.min(student.catTotal, 50);
    
    // Calculate overall total
    student.total = student.catTotal + student.exam;
}

// Update table name
function updateTableName(tableId, newName) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table) {
        table.name = newName || `Class ${dataset.tableCounter}`;
        saveToLocalStorage();
    }
}

// Update student name
function updateStudentName(tableId, studentIndex, newName) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table && table.students[studentIndex]) {
        table.students[studentIndex].name = newName || 'Unnamed Student';
        renderCurrentDataset();
        saveToLocalStorage();
    }
}

// Update student CAT mark
function updateStudentCatMark(tableId, studentIndex, catId, value) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table && table.students[studentIndex]) {
        table.students[studentIndex].catMarks[catId] = value;
        
        // Recalculate totals
        recalculateStudentTotals(table, table.students[studentIndex]);
        updatePositions(tableId);
        renderCurrentDataset();
        saveToLocalStorage();
    }
}

// Update student mark
function updateStudentMark(tableId, studentIndex, markType, value) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table && table.students[studentIndex]) {
        table.students[studentIndex][markType] = value;
        
        // Recalculate totals
        recalculateStudentTotals(table, table.students[studentIndex]);
        updatePositions(tableId);
        renderCurrentDataset();
        saveToLocalStorage();
    }
}

// Update positions based on total marks
function updatePositions(tableId) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table) {
        // Sort students by total marks in descending order
        const sortedStudents = [...table.students].sort((a, b) => b.total - a.total);
        
        // Assign positions
        let currentPosition = 1;
        let previousTotal = null;
        
        sortedStudents.forEach((student, index) => {
            // If this student has the same total as the previous, they share the position
            if (previousTotal !== null && student.total === previousTotal) {
                // Same position as previous student
                student.position = currentPosition;
            } else {
                currentPosition = index + 1;
                student.position = currentPosition;
            }
            
            previousTotal = student.total;
        });
    }
}

// Add a new student to a table
function addStudent(tableId) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table) {
        const newStudent = {
            name: 'New Student',
            exam: 0,
            catTotal: 0,
            total: 0,
            position: 0,
            catMarks: {}
        };
        
        // Initialize marks for each CAT column
        table.catColumns.forEach(cat => {
            newStudent.catMarks[cat.id] = 0;
        });
        
        table.students.push(newStudent);
        
        updatePositions(tableId);
        renderCurrentDataset();
        saveToLocalStorage();
    }
}

// Delete a student from a table
function deleteStudent(tableId, studentIndex) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (table && table.students[studentIndex]) {
        if (confirm('Are you sure you want to delete this student?')) {
            table.students.splice(studentIndex, 1);
            updatePositions(tableId);
            renderCurrentDataset();
            saveToLocalStorage();
        }
    }
}

// Delete a table
function deleteTable(tableId) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    if (confirm('Are you sure you want to delete this table? This action cannot be undone.')) {
        dataset.tables = dataset.tables.filter(t => t.id !== tableId);
        
        if (dataset.tables.length === 0) {
            showEmptyState();
        } else {
            renderCurrentDataset();
        }
        saveToLocalStorage();
    }
}

// Create new dataset
function createNewDataset() {
    const datasetName = prompt('Enter a name for the new dataset:', `Dataset ${resultDatasets.length + 1}`);
    if (!datasetName) return;
    
    const datasetId = generateId();
    const newDataset = {
        id: datasetId,
        name: datasetName,
        tables: [],
        tableCounter: 1
    };
    
    resultDatasets.push(newDataset);
    currentDatasetId = datasetId;
    
    updateCurrentDatasetIndicator();
    renderCurrentDataset();
    saveToLocalStorage();
    
    // Close the bulk list modal
    bulkListModal.style.display = 'none';
}

// Switch to a different dataset
function switchDataset(datasetId) {
    currentDatasetId = datasetId;
    updateCurrentDatasetIndicator();
    renderCurrentDataset();
    saveToLocalStorage();
    
    // Close the bulk list modal
    bulkListModal.style.display = 'none';
}

// Delete a dataset
function deleteDataset(datasetId) {
    if (resultDatasets.length <= 1) {
        alert('You cannot delete the last dataset. At least one dataset is required.');
        return;
    }
    
    const dataset = resultDatasets.find(d => d.id === datasetId);
    if (!dataset) return;
    
    if (!confirm(`Are you sure you want to delete the dataset "${dataset.name}"? This action cannot be undone and will delete all tables in this dataset.`)) {
        return;
    }
    
    // Remove the dataset
    resultDatasets = resultDatasets.filter(d => d.id !== datasetId);
    
    // If we deleted the current dataset, switch to the first available one
    if (currentDatasetId === datasetId) {
        if (resultDatasets.length > 0) {
            currentDatasetId = resultDatasets[0].id;
        } else {
            currentDatasetId = null;
        }
    }
    
    updateCurrentDatasetIndicator();
    renderCurrentDataset();
    saveToLocalStorage();
    
    // Update the bulk list if it's open
    if (bulkListModal.style.display === 'flex') {
        renderBulkList();
    }
}

// Show bulk list modal
function showBulkList() {
    renderBulkList();
    bulkListModal.style.display = 'flex';
}

// Render bulk list
function renderBulkList() {
    bulkListContainer.innerHTML = '';
    
    if (resultDatasets.length === 0) {
        bulkListContainer.innerHTML = '<p style="text-align: center;">No datasets available.</p>';
        return;
    }
    
    resultDatasets.forEach(dataset => {
        const listItem = document.createElement('div');
        listItem.className = `bulk-list-item ${dataset.id === currentDatasetId ? 'active' : ''}`;
        
        const itemInfo = document.createElement('div');
        itemInfo.className = 'bulk-list-item-info';
        
        const itemName = document.createElement('div');
        itemName.className = 'bulk-list-item-name';
        itemName.textContent = dataset.name;
        
        const itemDetails = document.createElement('div');
        itemDetails.className = 'bulk-list-item-details';
        itemDetails.textContent = `${dataset.tables.length} table(s), ${dataset.tables.reduce((total, table) => total + table.students.length, 0)} student(s)`;
        
        itemInfo.appendChild(itemName);
        itemInfo.appendChild(itemDetails);
        
        const itemActions = document.createElement('div');
        itemActions.className = 'bulk-list-item-actions';
        
        const switchBtn = document.createElement('button');
        switchBtn.className = 'btn-primary';
        switchBtn.innerHTML = 'üìã Switch';
        switchBtn.title = 'Switch to this dataset';
        switchBtn.addEventListener('click', () => switchDataset(dataset.id));
        
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-danger';
        deleteBtn.innerHTML = 'üóëÔ∏è Delete';
        deleteBtn.title = 'Delete this dataset';
        deleteBtn.addEventListener('click', () => deleteDataset(dataset.id));
        
        itemActions.appendChild(switchBtn);
        itemActions.appendChild(deleteBtn);
        
        listItem.appendChild(itemInfo);
        listItem.appendChild(itemActions);
        
        bulkListContainer.appendChild(listItem);
    });
}

// Handle bulk file import
function handleBulkFileImport(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    let filesProcessed = 0;
    let datasetsImported = 0;
    let datasetsUpdated = 0;
    
    // Process each file
    Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                
                // Check if this is a single dataset or a list of datasets
                if (Array.isArray(importedData)) {
                    // This is a list of datasets
                    importedData.forEach(data => {
                        if (isValidDataset(data)) {
                            importDataset(data);
                            datasetsImported++;
                        }
                    });
                } else if (isValidDataset(importedData)) {
                    // This is a single dataset
                    importDataset(importedData);
                    datasetsImported++;
                } else if (importedData.resultDatasets && Array.isArray(importedData.resultDatasets)) {
                    // This is a bulk export file
                    importedData.resultDatasets.forEach(dataset => {
                        if (isValidDataset(dataset)) {
                            importDataset(dataset);
                            datasetsImported++;
                        }
                    });
                } else {
                    throw new Error('Invalid data format');
                }
                
                filesProcessed++;
                
                // When all files are processed, show summary
                if (filesProcessed === files.length) {
                    showBulkImportSummary(datasetsImported, datasetsUpdated);
                    renderBulkList();
                    saveToLocalStorage();
                }
            } catch (error) {
                console.error('Error importing file:', file.name, error);
                filesProcessed++;
                
                // If this was the last file, show summary
                if (filesProcessed === files.length) {
                    showBulkImportSummary(datasetsImported, datasetsUpdated, true);
                }
            }
        };
        
        reader.readAsText(file);
    });
    
    // Reset file input
    event.target.value = '';
}

// Check if data is a valid dataset
function isValidDataset(data) {
    return data && 
           typeof data === 'object' && 
           data.id && 
           data.name && 
           Array.isArray(data.tables) &&
           typeof data.tableCounter === 'number';
}

// Import a dataset
function importDataset(importedDataset) {
    // Check if dataset with same ID already exists
    const existingDataset = resultDatasets.find(d => d.id === importedDataset.id);
    
    if (existingDataset) {
        // Update existing dataset
        existingDataset.name = importedDataset.name;
        existingDataset.tables = importedDataset.tables;
        existingDataset.tableCounter = importedDataset.tableCounter;
        return 'updated';
    } else {
        // Add new dataset
        resultDatasets.push({
            id: importedDataset.id,
            name: importedDataset.name,
            tables: importedDataset.tables,
            tableCounter: importedDataset.tableCounter
        });
        return 'imported';
    }
}

// Show bulk import summary
function showBulkImportSummary(datasetsImported, datasetsUpdated, hasErrors = false) {
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'import-summary';
    
    if (hasErrors) {
        summaryDiv.style.backgroundColor = '#f8d7da';
        summaryDiv.style.borderLeftColor = '#dc3545';
        
        summaryDiv.innerHTML = `
            <h4>‚ö†Ô∏è Bulk Import Completed with Errors</h4>
            <p>Some files could not be imported due to invalid format.</p>
            <ul>
                <li>Datasets imported: ${datasetsImported}</li>
                <li>Datasets updated: ${datasetsUpdated}</li>
            </ul>
        `;
    } else {
        summaryDiv.innerHTML = `
            <h4>‚úÖ Bulk Import Successful</h4>
            <ul>
                <li>Datasets imported: ${datasetsImported}</li>
                <li>Datasets updated: ${datasetsUpdated}</li>
            </ul>
            <p>Your datasets have been imported successfully. All changes have been saved automatically.</p>
        `;
    }
    
    // Insert at the top of the tables container
    tablesContainer.insertBefore(summaryDiv, tablesContainer.firstChild);
    
    // Remove the summary after 5 seconds
    setTimeout(() => {
        if (summaryDiv.parentNode) {
            summaryDiv.parentNode.removeChild(summaryDiv);
        }
    }, 5000);
}

// Bulk export data
function bulkExportData() {
    if (resultDatasets.length === 0) {
        alert('No datasets to export. Please create datasets first.');
        return;
    }
    
    const dataStr = JSON.stringify({
        resultDatasets: resultDatasets,
        currentDatasetId: currentDatasetId,
        exportedAt: new Date().toISOString()
    }, null, 2);
    
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'student-results-bulk-data.json';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


// Show statistics modal
function showStatistics() {
    const dataset = getCurrentDataset();
    if (!dataset || dataset.tables.length === 0) {
        alert('No tables available. Please create tables first.');
        return;
    }
    
    renderStatisticsTable();
    statisticsModal.style.display = 'flex';
}

// Render statistics table
function renderStatisticsTable() {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    // Get all unique student names across all tables
    const allStudentNames = [...new Set(
        dataset.tables.flatMap(table => table.students.map(student => student.name))
    )].sort();
    
    // Create statistics data structure
    const statisticsData = allStudentNames.map(name => {
        const studentData = { name, totals: [] };
        
        // For each table, find the student's total score
        dataset.tables.forEach(table => {
            const student = table.students.find(s => s.name === name);
            studentData.totals.push(student ? student.total : 0);
        });
        
        // Calculate overall total
        studentData.overallTotal = studentData.totals.reduce((sum, total) => sum + total, 0);
        
        return studentData;
    });
    
    // Sort by overall total (descending) for positioning
    statisticsData.sort((a, b) => b.overallTotal - a.overallTotal);
    
    // Assign positions
    let currentPosition = 1;
    let previousTotal = null;
    let skipPosition = 0;
    
    statisticsData.forEach((student, index) => {
        if (previousTotal !== null && student.overallTotal === previousTotal) {
            student.position = currentPosition;
            skipPosition++;
        } else {
            currentPosition = index + 1 - skipPosition;
            student.position = currentPosition;
        }
        previousTotal = student.overallTotal;
    });
    
    // Create the statistics table
    statisticsContainer.innerHTML = '';
    
    if (allStudentNames.length === 0) {
        statisticsContainer.innerHTML = '<p style="text-align: center;">No student data available.</p>';
        return;
    }
    
    const statsTable = document.createElement('table');
    statsTable.style.width = '100%';
    
    // Create header row
    const headerRow = document.createElement('tr');
    const nameHeader = document.createElement('th');
    nameHeader.textContent = 'NAMES';
    headerRow.appendChild(nameHeader);
    
    // Add table name headers
    dataset.tables.forEach(table => {
        const tableHeader = document.createElement('th');
        tableHeader.textContent = table.name;
        headerRow.appendChild(tableHeader);
    });
    
    // Add totals and position headers
    const totalsHeader = document.createElement('th');
    totalsHeader.textContent = 'TOTALS';
    headerRow.appendChild(totalsHeader);
    
    const positionHeader = document.createElement('th');
    positionHeader.textContent = 'POSITION';
    headerRow.appendChild(positionHeader);
    
    statsTable.appendChild(headerRow);
    
    // Create data rows
    statisticsData.forEach(student => {
        const row = document.createElement('tr');
        
        // Name cell (clickable)
        const nameCell = document.createElement('td');
        const nameSpan = document.createElement('span');
        nameSpan.textContent = student.name;
        nameSpan.className = 'clickable-name';
        nameSpan.addEventListener('click', () => showTerminalReport(student.name));
        nameCell.appendChild(nameSpan);
        row.appendChild(nameCell);
        
        // Table score cells
        student.totals.forEach(total => {
            const scoreCell = document.createElement('td');
            scoreCell.textContent = total;
            row.appendChild(scoreCell);
        });
        
        // Overall total cell
        const totalCell = document.createElement('td');
        totalCell.textContent = student.overallTotal;
        row.appendChild(totalCell);
        
        // Position cell
        const positionCell = document.createElement('td');
        positionCell.textContent = student.position;
        row.appendChild(positionCell);
        
        statsTable.appendChild(row);
    });
    
    statisticsContainer.appendChild(statsTable);
}

// Show terminal report for a student
function showTerminalReport(studentName) {
    // Close statistics modal first
    statisticsModal.style.display = 'none';
    
    // Generate terminal report
    renderTerminalReport(studentName);
    terminalReportModal.style.display = 'flex';
}

// Render terminal report for a student
function renderTerminalReport(studentName) {
    terminalReportContainer.innerHTML = '';
    
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    // Create terminal report container
    const reportDiv = document.createElement('div');
    reportDiv.className = 'terminal-report';
    
    // Create report header
    const headerDiv = document.createElement('div');
    headerDiv.style.textAlign = 'center';
    headerDiv.style.marginBottom = '20px';
    headerDiv.style.paddingBottom = '15px';
    headerDiv.style.borderBottom = '2px solid var(--primary)';
    
    const studentNameHeading = document.createElement('h2');
    studentNameHeading.textContent = `Terminal Report: ${studentName}`;
    studentNameHeading.style.color = 'var(--primary)';
    headerDiv.appendChild(studentNameHeading);
    
    const reportDate = document.createElement('p');
    reportDate.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
    reportDate.style.color = 'var(--gray)';
    headerDiv.appendChild(reportDate);
    
    reportDiv.appendChild(headerDiv);
    
    // Create results table
    const resultsTable = document.createElement('table');
    
    // Create table header
    const thead = document.createElement('thead');
    const headerRow = document.createElement('tr');
    
    const headers = ['SUBJECT', 'CAT TOTAL', 'EXAM', 'SUBJECT TOTAL', 'REMARKS'];
    headers.forEach(headerText => {
        const th = document.createElement('th');
        th.textContent = headerText;
        headerRow.appendChild(th);
    });
    
    thead.appendChild(headerRow);
    resultsTable.appendChild(thead);
    
    // Create table body
    const tbody = document.createElement('tbody');
    
    let grandTotal = 0;
    let totalPossible = 0;
    
    // Add rows for each table (subject)
    dataset.tables.forEach(table => {
        const student = table.students.find(s => s.name === studentName);
        if (student) {
            const row = document.createElement('tr');
            
            // Subject name
            const subjectCell = document.createElement('td');
            subjectCell.textContent = table.name;
            row.appendChild(subjectCell);
            
            // CAT Total
            const catTotalCell = document.createElement('td');
            catTotalCell.textContent = student.catTotal;
            row.appendChild(catTotalCell);
            
            // Exam
            const examCell = document.createElement('td');
            examCell.textContent = student.exam;
            row.appendChild(examCell);
            
            // Subject Total
            const subjectTotalCell = document.createElement('td');
            subjectTotalCell.textContent = student.total;
            row.appendChild(subjectTotalCell);
            
            // Remarks for subject
            const remarksCell = document.createElement('td');
            const subjectRemarks = getRemarks(student.total, 100);
            remarksCell.textContent = subjectRemarks.text;
            remarksCell.className = `remarks-cell ${subjectRemarks.class}`;
            row.appendChild(remarksCell);
            
            tbody.appendChild(row);
            
            // Update grand total
            grandTotal += student.total;
            totalPossible += 100; // Each subject is out of 100
        }
    });
    
    // Add grand total row
    const grandTotalRow = document.createElement('tr');
    grandTotalRow.style.fontWeight = 'bold';
    grandTotalRow.style.backgroundColor = '#f1f5fd';
    
    const grandTotalLabelCell = document.createElement('td');
    grandTotalLabelCell.textContent = 'GRAND TOTAL';
    grandTotalLabelCell.colSpan = 3;
    grandTotalRow.appendChild(grandTotalLabelCell);
    
    const grandTotalCell = document.createElement('td');
    grandTotalCell.textContent = grandTotal;
    grandTotalRow.appendChild(grandTotalCell);
    
    const overallRemarksCell = document.createElement('td');
    const overallPercentage = totalPossible > 0 ? (grandTotal / totalPossible) * 100 : 0;
    const overallRemarks = getRemarks(overallPercentage, 100);
    overallRemarksCell.textContent = overallRemarks.text;
    overallRemarksCell.className = `remarks-cell ${overallRemarks.class}`;
    grandTotalRow.appendChild(overallRemarksCell);
    
    tbody.appendChild(grandTotalRow);
    
    resultsTable.appendChild(tbody);
    reportDiv.appendChild(resultsTable);
    
    // Add comments section
    const commentsSection = document.createElement('div');
    commentsSection.className = 'comments-section';
    
    const commentsHeading = document.createElement('h3');
    commentsHeading.textContent = 'Teacher Comments:';
    commentsHeading.style.textAlign = 'center';
    commentsSection.appendChild(commentsHeading);
    
    const commentsTextarea = document.createElement('textarea');
    commentsTextarea.className = 'comments-textarea';
    commentsTextarea.placeholder = 'Enter teacher comments here...';
    commentsSection.appendChild(commentsTextarea);
    
    reportDiv.appendChild(commentsSection);
    
    // Add action buttons
    const actionsDiv = document.createElement('div');
    actionsDiv.className = 'terminal-report-actions';
    
    const printReportBtn = document.createElement('button');
    printReportBtn.className = 'btn-info';
    printReportBtn.innerHTML = 'üñ®Ô∏è Print Report';
    printReportBtn.addEventListener('click', () => printTerminalReport(studentName, commentsTextarea.value));
    
    const closeReportBtn = document.createElement('button');
    closeReportBtn.className = 'btn-secondary';
    closeReportBtn.innerHTML = '‚ùå Close';
    closeReportBtn.addEventListener('click', () => {
        terminalReportModal.style.display = 'none';
    });
    
    actionsDiv.appendChild(printReportBtn);
    actionsDiv.appendChild(closeReportBtn);
    
    reportDiv.appendChild(actionsDiv);
    
    terminalReportContainer.appendChild(reportDiv);
}

// Get remarks based on score
function getRemarks(score, maxScore) {
    const percentage = (score / maxScore) * 100;
    
    if (percentage >= 90) {
        return { text: 'Distinction', class: 'remarks-excellent' };
    } else if (percentage >= 80) {
        return { text: 'Excellent', class: 'remarks-excellent' };
    } else if (percentage >= 70) {
        return { text: 'Very Good', class: 'remarks-very-good' };
    } else if (percentage >= 60) {
        return { text: 'Good', class: 'remarks-good' };
    } else if (percentage >= 50) {
        return { text: 'Pass', class: 'remarks-pass' };
    } else {
        return { text: 'Fail', class: 'remarks-fail' };
    }
}

// Print terminal report
function printTerminalReport(studentName, comments) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    // Create a print-friendly version of the terminal report
    const printWindow = window.open('', '_blank');
    
    // Get the student data
    let grandTotal = 0;
    let totalPossible = 0;
    let subjectRows = '';
    
    dataset.tables.forEach(table => {
        const student = table.students.find(s => s.name === studentName);
        if (student) {
            const subjectRemarks = getRemarks(student.total, 100);
            subjectRows += `
                <tr>
                    <td>${table.name}</td>
                    <td>${student.catTotal}</td>
                    <td>${student.exam}</td>
                    <td>${student.total}</td>
                    <td class="remarks-cell ${subjectRemarks.class}">${subjectRemarks.text}</td>
                </tr>
            `;
            
            grandTotal += student.total;
            totalPossible += 100;
        }
    });
    
    const overallPercentage = totalPossible > 0 ? (grandTotal / totalPossible) * 100 : 0;
    const overallRemarks = getRemarks(overallPercentage, 100);
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Terminal Report - ${studentName}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                }
                .print-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                    margin-bottom: 20px;
                }
                .print-table th, .print-table td {
                    border: 1px solid #ddd;
                    padding: 8px 10px;
                    text-align: center;
                }
                .print-table th {
                    background-color: #f5f5f5;
                    font-weight: bold;
                }
                .print-table .remarks-cell {
                    font-weight: bold;
                }
                .remarks-excellent {
                    color: #28a745;
                }
                .remarks-very-good {
                    color: #20c997;
                }
                .remarks-good {
                    color: #17a2b8;
                }
                .remarks-pass {
                    color: #ffc107;
                }
                .remarks-fail {
                    color: #dc3545;
                }
                .comments-section {
                    margin-top: 20px;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 4px;
                }
                @page {
                    size: A4 portrait;
                    margin: 0.5cm;
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>Terminal Report</h1>
                <h2>${studentName}</h2>
                <p>Generated on: ${new Date().toLocaleDateString()}</p>
            </div>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>SUBJECT</th>
                        <th>CAT TOTAL</th>
                        <th>EXAM</th>
                        <th>SUBJECT TOTAL</th>
                        <th>REMARKS</th>
                    </tr>
                </thead>
                <tbody>
                    ${subjectRows}
                    <tr style="font-weight: bold; background-color: #f1f5fd;">
                        <td colspan="3">GRAND TOTAL</td>
                        <td>${grandTotal}</td>
                        <td class="remarks-cell ${overallRemarks.class}">${overallRemarks.text}</td>
                    </tr>
                </tbody>
            </table>
            <div class="comments-section">
                <h3>Teacher Comments:</h3>
                <p>${comments || 'No comments provided.'}</p>
            </div>
            <div style="margin-top: 20px; font-size: 12px; text-align: center;">
                School Stamp & Signature: _________________________
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load before printing
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Show help modal
function showHelp() {
    renderHelpContent();
    helpModal.style.display = 'flex';
}

// Render help content
function renderHelpContent() {
    helpContainer.innerHTML = `
        <div class="help-section">
            <h3>üìã Getting Started</h3>
            <p>Welcome to the Student Results Manager! This application helps teachers and school administrators manage student grades efficiently.</p>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>‚ûï Add New Table</h4>
                    <p>Create a new class or subject table with default student names.</p>
                </div>
                <div class="feature-card">
                    <h4>üìù Clone Names</h4>
                    <p>Create a new table with student names from an existing table (marks reset to 0).</p>
                </div>
                <div class="feature-card">
                    <h4>‚úèÔ∏è Edit Content</h4>
                    <p>Click on any cell to edit student names or marks. Changes save automatically.</p>
                </div>
                <div class="feature-card">
                    <h4>‚ûï Add Student</h4>
                    <p>Add new students to any table using the button at the bottom of each table.</p>
                </div>
            </div>
        </div>

        <div class="help-section">
            <h3>üìö Multiple Datasets</h3>
            <p>You can now work with multiple result datasets:</p>
            <ul>
                <li><strong>Bulk Import:</strong> Import multiple datasets from JSON files</li>
                <li><strong>Bulk Export:</strong> Export all your datasets as a single JSON file</li>
                <li><strong>Bulk List:</strong> View and switch between all your datasets</li>
                <li><strong>Dataset Management:</strong> Create new datasets or delete existing ones</li>
            </ul>
            <p>Each dataset acts as a separate workspace with its own tables and students.</p>
        </div>

        <div class="help-section">
            <h3>üî¢ Flexible Mark Input</h3>
            <p>You can enter marks in several formats and they will be automatically converted:</p>
            <ul>
                <li><strong>Fractions:</strong> e.g., "45/50" will be converted to the equivalent mark out of the category maximum</li>
                <li><strong>Percentages:</strong> e.g., "90%" will be converted to 90% of the category maximum</li>
                <li><strong>Direct numbers:</strong> e.g., "14" will be used directly (if within the allowed maximum)</li>
            </ul>
            <p><strong>Examples:</strong></p>
            <ul>
                <li>For CAT1 (max 15): "12/15" ‚Üí 12, "80%" ‚Üí 12, "14" ‚Üí 14</li>
                <li>For EXAM (max 50): "45/50" ‚Üí 45, "90%" ‚Üí 45, "48" ‚Üí 48</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>‚öôÔ∏è Dynamic CAT Columns</h3>
            <p>You can now customize the CAT columns for each table:</p>
            <ul>
                <li><strong>Add CAT Columns:</strong> Use the "Add CAT Column" button to create new assessment columns</li>
                <li><strong>Set Maximum Scores:</strong> Define the maximum score for each CAT column</li>
                <li><strong>Edit CAT Columns:</strong> Click the edit button to change a CAT column's name or maximum score</li>
                <li><strong>Delete CAT Columns:</strong> Remove CAT columns you no longer need</li>
            </ul>
            <p><strong>Note:</strong> When you delete a CAT column, all marks for that column will be permanently removed.</p>
        </div>

        <div class="help-section">
            <h3>üìä Data Management</h3>
            <ul>
                <li><strong>Automatic Saving:</strong> All changes are automatically saved to your browser's storage.</li>
                <li><strong>Export Data:</strong> Download all your data as a JSON file for backup or transfer.</li>
                <li><strong>Import Data:</strong> Merge data from JSON files with your existing data:
                    <ul>
                        <li>Tables with the same name will be merged (students updated/added)</li>
                        <li>New tables will be added to your existing data</li>
                        <li>Student records with the same name will be updated</li>
                    </ul>
                </li>
                <li><strong>Bulk Operations:</strong> Import/export multiple datasets at once</li>
                <li><strong>Clear Data:</strong> Remove all datasets and start fresh (use with caution!).</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üìà Statistics & Reports</h3>
            <ul>
                <li><strong>Statistics View:</strong> See an overview of all students across all tables with their total scores and positions.</li>
                <li><strong>Terminal Reports:</strong> Click on any student name in the statistics view to generate a detailed report card.</li>
                <li><strong>Print Reports:</strong> Generate professional A4-sized reports for parent meetings or student records.</li>
                <li><strong>Automatic Calculations:</strong> CAT totals, overall scores, and positions are calculated automatically.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üñ®Ô∏è Printing</h3>
            <ul>
                <li><strong>Table Printing:</strong> Print individual class tables using the print button on each table.</li>
                <li><strong>Report Printing:</strong> Generate and print professional terminal reports for students.</li>
                <li><strong>A4 Optimization:</strong> All print outputs are optimized for standard A4 paper size.</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üéØ Grading System</h3>
            <ul>
                <li><strong>CAT Marks:</strong> Each CAT column has its own maximum score that you define</li>
                <li><strong>Exam Marks:</strong> Maximum of 50 marks per subject</li>
                <li><strong>Total Calculation:</strong> CAT Total + Exam = Subject Total (out of 100)</li>
                <li><strong>Automatic Remarks:</strong>
                    <ul>
                        <li>Distinction: 90% and above</li>
                        <li>Excellent: 80% - 89%</li>
                        <li>Very Good: 70% - 79%</li>
                        <li>Good: 60% - 69%</li>
                        <li>Pass: 50% - 59%</li>
                        <li>Fail: Below 50%</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üí° Tips & Best Practices</h3>
            <ul>
                <li>Use descriptive table names (e.g., "Mathematics Grade 7" instead of "Class 1")</li>
                <li>Use descriptive dataset names to organize your work (e.g., "Term 1 2024", "Grade 7 Results")</li>
                <li>Regularly export your data as backup</li>
                <li>Use the statistics view to identify students who need extra help</li>
                <li>Add personalized comments in terminal reports for better parent communication</li>
                <li>Use the clone feature to create similar classes with the same student roster</li>
                <li>Take advantage of flexible mark input to enter marks in your preferred format</li>
                <li>Customize CAT columns to match your school's assessment structure</li>
            </ul>
        </div>

        <div class="help-section">
            <h3>üõ†Ô∏è Technical Information</h3>
            <ul>
                <li>This app works entirely in your browser - no server required</li>
                <li>Data is stored locally in your browser's storage</li>
                <li>Works offline once loaded</li>
                <li>Compatible with modern browsers (Chrome, Firefox, Safari, Edge)</li>
                <li>Responsive design works on desktop, tablet, and mobile devices</li>
            </ul>
        </div>
    `;
}

// Print a specific table
function printTable(tableId) {
    const dataset = getCurrentDataset();
    if (!dataset) return;
    
    const table = dataset.tables.find(t => t.id === tableId);
    if (!table) return;
    
    // Create a print-friendly version of the table
    const printWindow = window.open('', '_blank');
    
    // Create CAT column headers
    let catHeaders = '';
    table.catColumns.forEach(catColumn => {
        catHeaders += `<th>${catColumn.name} Marks ${catColumn.maxScore}</th>`;
    });
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>${table.name} - Student Results</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                }
                .print-header {
                    text-align: center;
                    margin-bottom: 20px;
                    border-bottom: 2px solid #333;
                    padding-bottom: 10px;
                }
                .print-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 14px;
                }
                .print-table th, .print-table td {
                    border: 1px solid #ddd;
                    padding: 8px 10px;
                    text-align: center;
                }
                .print-table th {
                    background-color: #f5f5f5;
                    font-weight: bold;
                }
                .print-table .position-cell {
                    font-weight: bold;
                }
                @page {
                    size: A4 portrait;
                    margin: 0.5cm;
                }
            </style>
        </head>
        <body>
            <div class="print-header">
                <h1>${table.name}</h1>
                <p>Student Results Summary</p>
            </div>
            <table class="print-table">
                <thead>
                    <tr>
                        <th>NAMES</th>
                        ${catHeaders}
                        <th>CAT Totals 50</th>
                        <th>EXAM Marks 50</th>
                        <th>TOTAL CAT+ EXAM Marks 100</th>
                        <th>POSITION S</th>
                    </tr>
                </thead>
                <tbody>
                    ${table.students.map(student => {
                        let catMarks = '';
                        table.catColumns.forEach(catColumn => {
                            catMarks += `<td>${student.catMarks[catColumn.id] || 0}</td>`;
                        });
                        
                        return `
                        <tr>
                            <td>${student.name}</td>
                            ${catMarks}
                            <td>${student.catTotal}</td>
                            <td>${student.exam}</td>
                            <td>${student.total}</td>
                            <td class="position-cell">${student.position}</td>
                        </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
            <div style="margin-top: 20px; font-size: 12px; text-align: center;">
                Generated on ${new Date().toLocaleDateString()}
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
    
    // Wait for content to load before printing
    printWindow.onload = function() {
        printWindow.print();
    };
}

// Hide empty state
function hideEmptyState() {
    emptyState.style.display = 'none';
}

// Show empty state
function showEmptyState() {
    emptyState.style.display = 'block';
}

// Export data as JSON (single dataset)
function exportData() {
    const dataset = getCurrentDataset();
    if (!dataset || dataset.tables.length === 0) {
        alert('No data to export. Please add tables first.');
        return;
    }
    
    const dataStr = JSON.stringify({
        ...dataset,
        exportedAt: new Date().toISOString()
    }, null, 2);
    
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `student-results-${dataset.name.replace(/\s+/g, '-').toLowerCase()}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

// Handle file import with merging (single dataset)
function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            const dataset = getCurrentDataset();
            
            if (!dataset) return;
            
            // Validate imported data structure
            if (Array.isArray(importedData.tables) && importedData.tables.every(item => 
                item.id && item.name && Array.isArray(item.students))) {
                
                const importSummary = mergeImportedData(importedData);
                renderCurrentDataset();
                hideEmptyState();
                saveToLocalStorage();
                
                // Show import summary
                showImportSummary(importSummary);
            } else {
                throw new Error('Invalid data format');
            }
        } catch (error) {
            alert('Error importing data: Invalid file format');
            console.error('Import error:', error);
        }
    };
    
    reader.readAsText(file);
    // Reset file input
    event.target.value = '';
}

// Merge imported data with existing data (single dataset)
function mergeImportedData(importedData) {
    const dataset = getCurrentDataset();
    if (!dataset) return { tablesAdded: 0, tablesUpdated: 0, studentsAdded: 0, studentsUpdated: 0 };
    
    const summary = {
        tablesAdded: 0,
        tablesUpdated: 0,
        studentsAdded: 0,
        studentsUpdated: 0
    };
    
    // Update table counter to avoid ID conflicts
    const maxExistingId = dataset.tables.reduce((max, table) => {
        const idNum = parseInt(table.id.replace('table-', ''));
        return idNum > max ? idNum : max;
    }, 0);
    
    dataset.tableCounter = Math.max(dataset.tableCounter, maxExistingId + 1);
    
    // Process each imported table
    importedData.tables.forEach(importedTable => {
        // Check if table with same name exists
        const existingTable = dataset.tables.find(t => t.name === importedTable.name);
        
        if (existingTable) {
            // Merge students into existing table
            summary.tablesUpdated++;
            
            importedTable.students.forEach(importedStudent => {
                const existingStudent = existingTable.students.find(s => s.name === importedStudent.name);
                
                if (existingStudent) {
                    // Update existing student
                    Object.assign(existingStudent, importedStudent);
                    summary.studentsUpdated++;
                } else {
                    // Add new student
                    existingTable.students.push(importedStudent);
                    summary.studentsAdded++;
                }
            });
            
            // Update positions for the merged table
            updatePositions(existingTable.id);
        } else {
            // Add new table
            // Generate new ID to avoid conflicts
            const newTableId = `table-${dataset.tableCounter++}`;
            importedTable.id = newTableId;
            dataset.tables.push(importedTable);
            summary.tablesAdded++;
            summary.studentsAdded += importedTable.students.length;
        }
    });
    
    return summary;
}

// Show import summary
function showImportSummary(summary) {
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'import-summary';
    
    summaryDiv.innerHTML = `
        <h4>‚úÖ Data Import Successful</h4>
        <ul>
            <li>Tables added: ${summary.tablesAdded}</li>
            <li>Tables updated: ${summary.tablesUpdated}</li>
            <li>Students added: ${summary.studentsAdded}</li>
            <li>Students updated: ${summary.studentsUpdated}</li>
        </ul>
        <p>Your data has been merged successfully. All changes have been saved automatically.</p>
    `;
    
    // Insert at the top of the tables container
    tablesContainer.insertBefore(summaryDiv, tablesContainer.firstChild);
    
    // Remove the summary after 5 seconds
    setTimeout(() => {
        if (summaryDiv.parentNode) {
            summaryDiv.parentNode.removeChild(summaryDiv);
        }
    }, 3000);
}


        // Clear all data
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone and will delete all datasets and tables.')) {
                resultDatasets = [];
                currentDatasetId = null;
                tableCounter = 1;
                localStorage.removeItem(STORAGE_KEY);
                showEmptyState();
                updateCurrentDatasetIndicator();
                saveStatus.textContent = 'All data cleared';
                saveStatus.className = '';
            }
        }

        // Reload function with confirmation
        function reloadPage() {
            if (confirm('Reload the page? All unsaved changes will be lost.')) {
                location.reload(true);
            }
        }

        // Handle edge cases for dataset operations
        function handleDatasetEdgeCases() {
            // Ensure we always have at least one dataset
            if (resultDatasets.length === 0) {
                createDefaultDataset();
            }
            
            // Ensure currentDatasetId is valid
            if (currentDatasetId && !resultDatasets.find(d => d.id === currentDatasetId)) {
                currentDatasetId = resultDatasets.length > 0 ? resultDatasets[0].id : null;
            }
            
            // If no current dataset but datasets exist, set to first one
            if (!currentDatasetId && resultDatasets.length > 0) {
                currentDatasetId = resultDatasets[0].id;
            }
        }

        // Validate and repair dataset structure
        function validateAndRepairDataset(dataset) {
            if (!dataset.tables) dataset.tables = [];
            if (!dataset.tableCounter) dataset.tableCounter = 1;
            
            // Ensure all tables have required structure
            dataset.tables.forEach(table => {
                if (!table.id) table.id = `table-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                if (!table.name) table.name = 'Unnamed Table';
                if (!table.catColumns) table.catColumns = [...defaultCatColumns];
                if (!table.students) table.students = [];
                
                // Ensure all students have required structure
                table.students.forEach(student => {
                    if (!student.name) student.name = 'Unnamed Student';
                    if (!student.catMarks) student.catMarks = {};
                    if (typeof student.exam !== 'number') student.exam = 0;
                    if (typeof student.catTotal !== 'number') student.catTotal = 0;
                    if (typeof student.total !== 'number') student.total = 0;
                    if (typeof student.position !== 'number') student.position = 0;
                    
                    // Ensure all CAT columns have marks
                    table.catColumns.forEach(cat => {
                        if (typeof student.catMarks[cat.id] !== 'number') {
                            student.catMarks[cat.id] = 0;
                        }
                    });
                    
                    // Recalculate totals
                    recalculateStudentTotals(table, student);
                });
                
                // Update positions
                updatePositions(table.id);
            });
            
            return dataset;
        }

        // Enhanced save with validation
        function saveToLocalStorageWithValidation() {
            // Validate and repair all datasets before saving
            resultDatasets.forEach(dataset => {
                validateAndRepairDataset(dataset);
            });
            
            // Handle edge cases
            handleDatasetEdgeCases();
            
            // Proceed with saving
            saveToLocalStorage();
        }

        // Override the original save function with enhanced version
        const originalSaveToLocalStorage = saveToLocalStorage;
        saveToLocalStorage = saveToLocalStorageWithValidation;

        // Enhanced error handling for file operations
        function handleFileOperationError(error, operation) {
            console.error(`Error during ${operation}:`, error);
            
            let errorMessage = 'An error occurred during the operation.';
            
            if (error instanceof SyntaxError) {
                errorMessage = 'Invalid file format. Please ensure you are importing a valid JSON file.';
            } else if (error instanceof TypeError) {
                errorMessage = 'File format not supported.';
            } else if (error.message.includes('QuotaExceededError')) {
                errorMessage = 'Storage limit exceeded. Please clear some data or export existing data.';
            }
            
            // Show error to user
            const errorDiv = document.createElement('div');
            errorDiv.className = 'import-summary';
            errorDiv.style.backgroundColor = '#f8d7da';
            errorDiv.style.borderLeftColor = '#dc3545';
            
            errorDiv.innerHTML = `
                <h4>‚ùå Operation Failed</h4>
                <p>${errorMessage}</p>
                <p style="font-size: 0.8rem; margin-top: 5px;">Technical details: ${error.message}</p>
            `;
            
            // Insert at the top of the tables container
            tablesContainer.insertBefore(errorDiv, tablesContainer.firstChild);
            
            // Remove the error after 7 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 3000);
        }

        // Enhanced file import with better error handling
        const originalHandleFileImport = handleFileImport;
        handleFileImport = function(event) {
            try {
                originalHandleFileImport(event);
            } catch (error) {
                handleFileOperationError(error, 'file import');
            }
        };

        // Enhanced bulk import with better error handling
        const originalHandleBulkFileImport = handleBulkFileImport;
        handleBulkFileImport = function(event) {
            try {
                originalHandleBulkFileImport(event);
            } catch (error) {
                handleFileOperationError(error, 'bulk import');
            }
        };

        // Auto-save on beforeunload
        window.addEventListener('beforeunload', function() {
            saveToLocalStorage();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S or Cmd+S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveToLocalStorage();
                // Show temporary feedback
                const originalText = saveStatus.textContent;
                saveStatus.textContent = 'Manually saved!';
                setTimeout(() => {
                    saveStatus.textContent = originalText;
                }, 2000);
            }
            
            // Escape to close modals
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal-overlay[style*="display: flex"]');
                openModals.forEach(modal => {
                    modal.style.display = 'none';
                });
            }
        });

        // Enhanced initialization with error recovery
        function enhancedInit() {
            try {
                loadFromLocalStorage();
                
                // Handle edge cases
                handleDatasetEdgeCases();
                
                // Validate and repair all datasets
                resultDatasets.forEach(dataset => {
                    validateAndRepairDataset(dataset);
                });
                
                // If no datasets exist, create a default one
                if (resultDatasets.length === 0) {
                    createDefaultDataset();
                }
                
                // Set current dataset if not set
                if (!currentDatasetId && resultDatasets.length > 0) {
                    currentDatasetId = resultDatasets[0].id;
                }
                
                updateCurrentDatasetIndicator();
                renderCurrentDataset();
                
                console.log('Application initialized successfully');
            } catch (error) {
                console.error('Error during initialization:', error);
                
                // Show error to user but don't prevent app from loading
                const errorDiv = document.createElement('div');
                errorDiv.className = 'import-summary';
                errorDiv.style.backgroundColor = '#fff3cd';
                errorDiv.style.borderLeftColor = '#ffc107';
                
                errorDiv.innerHTML = `
                    <h4>‚ö†Ô∏è Data Load Issue</h4>
                    <p>There was a problem loading your saved data. Some features may not work correctly.</p>
                    <p style="font-size: 0.8rem; margin-top: 5px;">You can continue working, but consider exporting your data and refreshing the page.</p>
                `;
                
                // Insert at the top of the container
                const container = document.querySelector('.container');
                container.insertBefore(errorDiv, container.firstChild);
                
                // Create default dataset to ensure app is usable
                createDefaultDataset();
                updateCurrentDatasetIndicator();
                renderCurrentDataset();
            }
        }

        // Export dataset as template
        function exportDatasetTemplate() {
            const template = {
                id: generateId(),
                name: 'Template Dataset',
                tables: [
                    {
                        id: 'table-1',
                        name: 'Mathematics',
                        catColumns: [...defaultCatColumns],
                        students: initialStudents.map(name => ({
                            name,
                            exam: 0,
                            catTotal: 0,
                            total: 0,
                            position: 0,
                            catMarks: defaultCatColumns.reduce((acc, cat) => {
                                acc[cat.id] = 0;
                                return acc;
                            }, {})
                        }))
                    }
                ],
                tableCounter: 2
            };
            
            const dataStr = JSON.stringify(template, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'student-results-template.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Add template export button to help section
        function enhanceHelpContent() {
            const originalRenderHelpContent = renderHelpContent;
            renderHelpContent = function() {
                originalRenderHelpContent();
                
                const templateSection = document.createElement('div');
                templateSection.className = 'help-section';
                templateSection.style.textAlign = 'center';
                templateSection.style.marginTop = '30px';
                templateSection.style.paddingTop = '20px';
                templateSection.style.borderTop = '2px solid var(--primary)';
                
                templateSection.innerHTML = `
                    <h3>üöÄ Quick Start</h3>
                    <p>Need a starting point? Download our template to see how the data should be structured.</p>
                    <button id="exportTemplateBtn" class="btn-primary" style="margin-top: 15px;">
                        üì• Download Template
                    </button>
                `;
                
                helpContainer.appendChild(templateSection);
                
                // Add event listener for the template button
                document.getElementById('exportTemplateBtn').addEventListener('click', exportDatasetTemplate);
            };
        }

        // Data integrity check
        function performDataIntegrityCheck() {
            const issues = [];
            
            resultDatasets.forEach((dataset, datasetIndex) => {
                if (!dataset.id || !dataset.name) {
                    issues.push(`Dataset ${datasetIndex + 1} is missing ID or name`);
                }
                
                dataset.tables.forEach((table, tableIndex) => {
                    if (!table.id || !table.name) {
                        issues.push(`Table ${tableIndex + 1} in dataset "${dataset.name}" is missing ID or name`);
                    }
                    
                    // Check for duplicate student names
                    const studentNames = table.students.map(s => s.name);
                    const duplicateNames = studentNames.filter((name, index) => studentNames.indexOf(name) !== index);
                    if (duplicateNames.length > 0) {
                        issues.push(`Table "${table.name}" has duplicate student names: ${duplicateNames.join(', ')}`);
                    }
                    
                    // Check for invalid marks
                    table.students.forEach(student => {
                        table.catColumns.forEach(cat => {
                            const mark = student.catMarks[cat.id];
                            if (mark < 0 || mark > cat.maxScore) {
                                issues.push(`Invalid mark ${mark} for ${student.name} in ${cat.name} (should be 0-${cat.maxScore})`);
                            }
                        });
                        
                        if (student.exam < 0 || student.exam > 50) {
                            issues.push(`Invalid exam mark ${student.exam} for ${student.name} (should be 0-50)`);
                        }
                    });
                });
            });
            
            return issues;
        }

        // Show data integrity report
        function showDataIntegrityReport() {
            const issues = performDataIntegrityCheck();
            
            if (issues.length === 0) {
                alert('‚úÖ No data integrity issues found! Your data is in good shape.');
                return;
            }
            
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Data Integrity Report</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            line-height: 1.6;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding-bottom: 15px;
                            border-bottom: 2px solid #333;
                        }
                        .issue {
                            background-color: #f8f9fa;
                            padding: 10px 15px;
                            margin-bottom: 10px;
                            border-left: 4px solid #dc3545;
                            border-radius: 4px;
                        }
                        .summary {
                            background-color: #e8f5e8;
                            padding: 15px;
                            margin-top: 20px;
                            border-radius: 8px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>üìä Data Integrity Report</h1>
                        <p>Generated on: ${new Date().toLocaleDateString()}</p>
                    </div>
                    
                    <h2>Issues Found (${issues.length})</h2>
                    ${issues.map(issue => `<div class="issue">${issue}</div>`).join('')}
                    
                    <div class="summary">
                        <h3>Recommendations</h3>
                        <ul>
                            <li>Review and fix the issues listed above</li>
                            <li>Export your data regularly as backup</li>
                            <li>Use the template for creating new datasets</li>
                            <li>Consider clearing and re-importing data if issues persist</li>
                        </ul>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Print Report
                        </button>
                        <button onclick="window.close()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">
                            Close
                        </button>
                    </div>
                </body>
                </html>
            `);
            reportWindow.document.close();
        }

        // Add data integrity check to help section
        function addDataIntegrityToHelp() {
            const originalEnhanceHelpContent = enhanceHelpContent;
            enhanceHelpContent = function() {
                originalEnhanceHelpContent();
                
                const integritySection = document.createElement('div');
                integritySection.className = 'help-section';
                integritySection.style.textAlign = 'center';
                integritySection.style.marginTop = '20px';
                
                integritySection.innerHTML = `
                    <h3>üîç Data Health Check</h3>
                    <p>Run a comprehensive check to identify any data integrity issues in your datasets.</p>
                    <button id="dataIntegrityBtn" class="btn-warning" style="margin-top: 15px;">
                        üîç Run Data Integrity Check
                    </button>
                `;
                
                helpContainer.appendChild(integritySection);
                
                // Add event listener for the integrity button
                document.getElementById('dataIntegrityBtn').addEventListener('click', showDataIntegrityReport);
            };
        }

        // Final initialization with all enhancements
        function finalInit() {
            // Apply all enhancements
            enhanceHelpContent();
            addDataIntegrityToHelp();
            
            // Initialize the application
            enhancedInit();
            
            // Add data integrity check button to controls (optional)
            const integrityBtn = document.createElement('button');
            integrityBtn.className = 'btn-warning';
            integrityBtn.innerHTML = 'üîç Data Check';
            integrityBtn.title = 'Run data integrity check';
            integrityBtn.addEventListener('click', showDataIntegrityReport);
            
            // Insert before the clear data button
            const controls = document.querySelector('.controls');
            controls.insertBefore(integrityBtn, clearDataBtn);
            
            console.log('Student Results Manager fully initialized with bulk operations support');
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', finalInit);

        // Export functions for debugging (development only)
        if (typeof window !== 'undefined') {
            window.debugApp = {
                getCurrentDataset,
                getCurrentTables,
                resultDatasets,
                currentDatasetId,
                performDataIntegrityCheck,
                validateAndRepairDataset,
                exportDatasetTemplate
            };
        }
    </script>
</body>
</html>